$(function(){function e(){$.getJSON(__BASEURL__+"mshop/order_api/detail",{tradeno:_},function(e){if(e.success){var n=e.data.afsno,t=e.data.is_afs_finished;$("#orderDetail").html(template(O,e.data)),"0"!=n&&("1"==t?$("#refund-footer").hide():$("#refund-footer").show(),w.data("afsno",n),y.data("afsno",n),s(n))}else new Msg({type:"danger",msg:e.msg})})}function s(e){$.getJSON(__BASEURL__+"mshop/afs_api/detail",{id:e},function(e){e.success?$("#refundCon").html(template(E,e.data)):new Msg({type:"danger",msg:e.msg})})}function n(){$("#refuse-form").bootstrapValidator({fields:{refuse_reason:{validators:{notEmpty:{message:"拒绝理由不能为空"},stringLength:{max:80,message:"拒绝理由不得超过80个字符"}}}}}).on("success.form.bv",function(s){s.preventDefault();var n=y.data("afsno"),t=$("#refuse_reason").val();y.prop("disabled",!0),$.post(__BASEURL__+"mshop/afs_api/refuse",autoCsrf({afsno:n,reason:t}),function(s){s.success?(new Msg({type:"success",msg:"拒绝成功"}),e()):new Msg({type:"danger",msg:s.msg}),y.prop("disabled",!1),h.modal("hide")})})}function t(){h.modal("show"),$("#refuse_reason").val(""),y.prop("disabled",!1),$("#refuse-form").data("bootstrapValidator").destroy(),$("#refuse-form").data("bootstrapValidator",null),n()}function o(){M.modal("show")}function r(s){$.post(__BASEURL__+"mshop/order_api/orderAgree",autoCsrf({tradeno:s}),function(s){s.success?(new Msg({type:"success",msg:"接单成功"}),e()):new Msg({type:"danger",msg:s.msg})})}function a(s){$.post(__BASEURL__+"mshop/order_api/orderRefuse",autoCsrf({tradeno:s}),function(s){s.success?(new Msg({type:"success",msg:"拒接成功"}),e()):new Msg({type:"danger",msg:s.msg})})}function d(s){$.post(__BASEURL__+"mshop/order_api/printOrder",autoCsrf({tradeno:s}),function(n){n.success?2==+n.data.print_type?i(s,+n.data.print_times):(new Msg({type:"success",msg:"打印成功"}),e()):new Msg({type:"danger",msg:n.msg})})}function i(e,s){s=s||1,$.getJSON(__BASEURL__+"mshop/order_api/detail",{tradeno:e},function(e){if(e.success){if(!e.data)return;p(e.data),LODOP.SET_PRINT_COPIES(s),LODOP.PRINT()}else console.log(e.msg)})}function u(s){$.get(__BASEURL__+"mshop/task/simTakingOrder",{tradeno:s},function(s){s.success?(new Msg({type:"success",msg:"接单成功"}),e()):new Msg({type:"danger",msg:s.msg})})}function c(s){$.get(__BASEURL__+"mshop/task/simDeliveredOrder",{tradeno:s},function(s){s.success?(new Msg({type:"success",msg:"送达成功"}),e()):new Msg({type:"danger",msg:s.msg})})}function g(s){$.post(__BASEURL__+"mshop/order_api/confirmDelivered",autoCsrf({tradeno:s}),function(s){s.success?(new Msg({type:"success",msg:"确认成功"}),e()):new Msg({type:"danger",msg:s.msg})})}function f(s){$.post(__BASEURL__+"mshop/order_api/rePushOrder",autoCsrf({tradeno:s}),function(s){s.success?(new Msg({type:"success",msg:"重新派单成功"}),e()):new Msg({type:"danger",msg:s.msg})})}function m(s){$.post(__BASEURL__+"mshop/order_api/turnSellerDelivery",autoCsrf({tradeno:s}),function(s){s.success?(new Msg({type:"success",msg:"成功转换为商家配送"}),e()):new Msg({type:"danger",msg:s.msg})})}function p(e){var s=template(L,e);LODOP=getLodop(),LODOP.PRINT_INIT("云店宝订单"),LODOP.ADD_PRINT_HTM(0,0,"100%","100%",s),LODOP.SET_PRINT_PAGESIZE(3,570,5,"CreateCustomPage")}var _=$("#tradeno").val(),l=$("#btn-refuse"),w=$("#confirm-refund"),y=$("#confirm-refuse"),M=$("#refundModal"),h=$("#refuseModal"),O=document.getElementById("orderDetailTpl").innerHTML,L=document.getElementById("orderPrintTpl").innerHTML,E=document.getElementById("refundTpl").innerHTML;e(),n(),w.on("click",function(){var s=$(this),n=s.data("afsno");s.prop("disabled",!0),$.post(__BASEURL__+"mshop/afs_api/agree",autoCsrf({afsno:n}),function(n){n.success?(new Msg({type:"success",msg:"退款成功"}),e()):new Msg({type:"danger",msg:n.msg}),s.prop("disabled",!1),M.modal("hide")})}),l.on("click",function(){M.modal("hide"),t()}),window.agreeOrder=r,window.refuseOrder=a,window.refundOrder=o,window.printOrder=d,window.simTakingOrder=u,window.simDeliveredOrder=c,window.confirmDelivered=g,window.rePushOrder=f,window.turnSellerDelivery=m});