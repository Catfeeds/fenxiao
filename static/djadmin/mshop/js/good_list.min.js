$(function(){function e(e){$.getJSON(__BASEURL__+"mshop/items_api/get_all_cate",{shop_id:L},function(t){t.success&&(u.html(template(b,{list:t.data})),e&&e())})}function t(e){$.getJSON(__BASEURL__+"mshop/items_api/goods_list",{current_page:e||1,page_size:B,shop_id:L,cate_id:U,status:A,title:T},function(s){if(s.success){for(var o=Math.ceil(+s.data.total/B),n=0;n<s.data.rows.length;n++)s.data.rows[n].sku_list.forEach(function(e){if(e.use_stock_num<0)return void(s.data.rows[n].is_num_hide=!0)});$('[name="selectAll"]').prop("checked",!1),$("#goodTbody").html(template(M,s.data)),laypage({cont:"goodPage",pages:o,curr:e||1,skin:"#5aa2e7",first:1,last:o,skip:!0,prev:"&lt",next:"&gt",jump:function(e,s){s||(S=e.curr,t(e.curr))}})}})}function s(e){f.data("id",e),h.modal("show")}function o(e){$.post(__BASEURL__+"mshop/items_api/shelves_up",autoCsrf({goods_id:e,shop_id:L}),function(e){m.prop("disabled",!1),e.success?(new Msg({type:"success",msg:"上架成功"}),t(S)):new Msg({type:"danger",msg:e.msg})})}function n(e){$.post(__BASEURL__+"mshop/items_api/shelves_down",autoCsrf({goods_id:e,shop_id:L}),function(e){g.prop("disabled",!1),e.success?(new Msg({type:"success",msg:"下架成功"}),t(S)):new Msg({type:"danger",msg:e.msg})})}function a(){var e=[];return $('[name="selectItem"]:checked').each(function(){e.push($(this).val())}),e.length<1?(new Msg({type:"danger",msg:"请先选择商品"}),!1):e.join(",")}function i(e,t,s){k.data("bootstrapValidator").destroy(),k.data("bootstrapValidator",null),y.html('<p class="text-center">加载中...</p>'),$.getJSON(__BASEURL__+"mshop/items_api/stock_sku_list",{goods_id:e},function(e){e.sku_type=t,y.html(template(E,e)),2==s&&$(".use_stock_num").each(function(){$(this).attr("name","use_stock_num2")}),d()}),v.modal("show")}function d(){$("#inventory-form").bootstrapValidator({fields:{use_stock_num:{validators:{notEmpty:{message:"可用库存不能为空"},regexp:{regexp:/^(0|[1-9][0-9]*|-[1-9][0-9]*)$/,message:"请输入整数"}}},use_stock_num2:{validators:{notEmpty:{message:"可用库存不能为空"}}}}}).on("success.form.bv",function(e){e.preventDefault();var s=y.find(".use_stock_num"),o=[];return s.each(function(e){var t=$(this),s=t.data("id"),n=+t.val();o.push({sku_id:s,use_stock_num:n})}),o.length<1?(v.modal("hide"),!1):(w.prop("disabled",!0),void $.post(__BASEURL__+"mshop/items_api/edit_sku_stock",autoCsrf({shop_id:L,sku:JSON.stringify(o)}),function(e){w.prop("disabled",!1),e.success?(new Msg({type:"success",msg:"修改成功"}),v.modal("hide"),t(S)):new Msg({type:"danger",msg:e.msg})}))})}var c=$("#shop_id"),u=$("#cate_id"),l=$("#status"),r=$("#title"),_=$("#btn-search"),p=$("#btn-add-good"),m=$("#batchShelvesUp"),g=$("#batchShelvesDown"),h=$("#delGoodModal"),f=$("#del-confirm"),v=$("#editInventoryModal"),w=$("#save-inventory"),y=$("#inventoryTable"),k=$("#inventory-form"),b=document.getElementById("cateTpl").innerHTML,M=document.getElementById("goodTpl").innerHTML,E=document.getElementById("inventoryTableTpl").innerHTML,S=1,B=10,L=c.val(),U=u.val(),A=l.val(),T=r.val();e(),t(),d(),c.on("change",function(){L=c.val(),u.val(""),U="",e(),t(1)}),u.on("change",function(){U=u.val(),t(1)}),l.on("change",function(){A=l.val(),t(1)}),_.on("click",function(){T=r.val(),t(1)}),p.on("click",function(){return L?void(window.location.href=__BASEURL__+"mshop/items/add/"+L):(new Msg({type:"danger",msg:"请先添加门店"}),!1)}),f.on("click",function(){var e=f.data("id");$.post(__BASEURL__+"mshop/items_api/goods_del",autoCsrf({goods_id:e}),function(e){h.modal("hide"),e.success?(new Msg({type:"success",msg:"删除成功"}),t(S)):new Msg({type:"danger",msg:e.msg})})}),m.on("click",function(){var e=a();return!!e&&(m.prop("disabled",!0),void o(e))}),g.on("click",function(){var e=a();return!!e&&(g.prop("disabled",!0),void n(e))}),window.delGood=s,window.shelvesUp=o,window.shelvesDown=n,window.editInventory=i});