$(function(){function e(){G=GetQueryString("status")||"",E.val(G)}function s(){var e=GetQueryString("create_time");e&&(K=e,x=K.split(" - ")[0],J=K.split(" - ")[1])}function t(){var e=sessionStorage.getItem("PICKUP_ORDER_QUERY")?JSON.parse(sessionStorage.getItem("PICKUP_ORDER_QUERY")):null;e&&(Q=e.cur_page,z=e.page_size,j=e.phone,L.val(j),W=e.logistics_code,O.val(W),V=e.tradeno,D.val(V),K=e.create_time,x=K.split(" - ")[0],J=K.split(" - ")[1],G=e.status,E.find("option[value = '"+G+"']").attr("selected",!0),H=e.shop_id,S.find("option[value = '"+H+"']").attr("selected",!0))}function n(){function e(e,s){K=e.format("YYYY-MM-DD")+" - "+s.format("YYYY-MM-DD"),b.val(K),o(1)}b.daterangepicker({startDate:x,endDate:J,maxDate:J,applyClass:"btn-primary",cancelClass:"btn-default",locale:{applyLabel:"确认",cancelLabel:"取消",fromLabel:"起始时间",toLabel:"结束时间",customRangeLabel:"自定义",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],firstDay:1,format:"YYYY-MM-DD"},ranges:{"今日":[moment(),moment()],"昨日":[moment().subtract(1,"days"),moment().subtract(1,"days")],"最近7日":[moment().subtract(6,"days"),moment()],"最近30日":[moment().subtract(29,"days"),moment()]}},e)}function o(e){var s={cur_page:Q,page_size:z,shop_id:H,status:G,create_time:K,tradeno:V,phone:j,logistics_code:W};sessionStorage.setItem("PICKUP_ORDER_QUERY",JSON.stringify(s)),$.getJSON(__BASEURL__+"mshop/order_api/self_pick_up_list",{current_page:e||1,page_size:z,shop_id:H,status:G,create_time:K,tradeno:V,phone:j,logistics_code:W},function(s){if(s.success){var t=Math.ceil(+s.data.total/z);$("#orderTbody").html(template(B,s.data)),laypage({cont:"orderPage",pages:t,curr:e||1,skin:"#5aa2e7",first:1,last:t,skip:!0,prev:"&lt",next:"&gt",jump:function(e,s){s||(o(e.curr),Q=e.curr)}})}})}function a(e){$(".hover_table"+e).hide()}function r(e){$(".hover_table"+e).show()}function i(e){$("#refundCon").html('<div class="m-empty-box"><p>加载中...</p></div>'),$.getJSON(__BASEURL__+"mshop/afs_api/detail",{id:e},function(e){e.success?$("#refundCon").html(template(N,e.data)):new Msg({type:"danger",msg:e.msg})})}function d(){$("#refuse-form").bootstrapValidator({fields:{refuse_reason:{validators:{notEmpty:{message:"拒绝理由不能为空"},stringLength:{max:80,message:"拒绝理由不得超过80个字符"}}}}}).on("success.form.bv",function(e){e.preventDefault();var s=P.data("afsno"),t=$("#refuse_reason").val();P.prop("disabled",!0),$.post(__BASEURL__+"mshop/afs_api/refuse",autoCsrf({afsno:s,reason:t}),function(e){e.success?(new Msg({type:"success",msg:"拒绝成功"}),o(Q)):new Msg({type:"danger",msg:e.msg}),P.prop("disabled",!1),A.modal("hide")})})}function c(){A.modal("show"),$("#refuse_reason").val(""),P.prop("disabled",!1),$("#refuse-form").data("bootstrapValidator").destroy(),$("#refuse-form").data("bootstrapValidator",null),d()}function u(e,s){"0"!=e&&("1"==s?$("#refund-footer").hide():$("#refund-footer").show(),I.data("afsno",e),P.data("afsno",e),i(e)),T.modal("show")}function p(e){$.post(__BASEURL__+"mshop/order_api/orderAgree",autoCsrf({tradeno:e}),function(e){e.success?(new Msg({type:"success",msg:"接单成功"}),o(Q)):new Msg({type:"danger",msg:e.msg})})}function m(e){$.post(__BASEURL__+"mshop/order_api/orderRefuse",autoCsrf({tradeno:e}),function(e){e.success?(new Msg({type:"success",msg:"拒接成功"}),o(Q)):new Msg({type:"danger",msg:e.msg})})}function _(e){$.post(__BASEURL__+"mshop/order_api/printOrder",autoCsrf({tradeno:e}),function(s){s.success?2==+s.data.print_type?g(e,+s.data.print_times):(new Msg({type:"success",msg:"打印成功"}),o(Q)):new Msg({type:"danger",msg:s.msg})})}function g(e,s){s=s||1,$.getJSON(__BASEURL__+"mshop/order_api/detail",{tradeno:e},function(e){if(e.success){if(!e.data)return;v(e.data),R.SET_PRINT_COPIES(s),R.PRINT()}else console.log(e.msg)})}function f(e){$.get(__BASEURL__+"mshop/task/simTakingOrder",{tradeno:e},function(e){e.success?(new Msg({type:"success",msg:"接单成功"}),o(Q)):new Msg({type:"danger",msg:e.msg})})}function l(e){$.get(__BASEURL__+"mshop/task/simDeliveredOrder",{tradeno:e},function(e){e.success?(new Msg({type:"success",msg:"送达成功"}),o(Q)):new Msg({type:"danger",msg:e.msg})})}function w(e){$.post(__BASEURL__+"mshop/order_api/confirmDelivered",autoCsrf({tradeno:e}),function(e){e.success?(new Msg({type:"success",msg:"确认成功"}),o(Q)):new Msg({type:"danger",msg:e.msg})})}function h(e){$.post(__BASEURL__+"mshop/order_api/rePushOrder",autoCsrf({tradeno:e}),function(e){e.success?(new Msg({type:"success",msg:"重新派单成功"}),o(Q)):new Msg({type:"danger",msg:e.msg})})}function y(e){$.post(__BASEURL__+"mshop/order_api/turnSellerDelivery",autoCsrf({tradeno:e}),function(e){e.success?(new Msg({type:"success",msg:"成功转换为商家配送"}),o(Q)):new Msg({type:"danger",msg:e.msg})})}function v(e){var s=template(k,e);R=getLodop(),R.PRINT_INIT("云店宝订单"),R.ADD_PRINT_HTM(0,0,"100%","100%",s),R.SET_PRINT_PAGESIZE(3,570,5,"CreateCustomPage")}function M(){var e=__BASEURL__+"mshop/order_api/export_pick_up?shop_id="+H+"&current_page=1&page_size=9999&status="+G+"&create_time="+K+"&tradeno="+V+"&logistics_code="+W+"&phone="+j;window.open(e)}var R,S=$("#shop"),E=$("#status"),b=$("#create_time"),D=$("#tradeno"),L=$("#phone"),O=$("#code"),Y=$("#btn-search"),U=$("#btn-refresh"),C=$("#btn-refuse"),I=$("#confirm-refund"),P=$("#confirm-refuse"),T=$("#refundModal"),A=$("#refuseModal"),B=document.getElementById("orderTpl").innerHTML,k=document.getElementById("orderPrintTpl").innerHTML,N=document.getElementById("refundTpl").innerHTML,x=moment().subtract(29,"days"),J=moment(),Q=1,z=10,H=S.val(),G=E.val(),K=x.format("YYYY-MM-DD")+" - "+J.format("YYYY-MM-DD"),V=D.val(),j=L.val(),W=O.val();e(),s(),t(),n(),o(Q),d(),S.on("change",function(){H=$(this).val(),o(1)}),E.on("change",function(){G=$(this).val(),o(1)}),Y.on("click",function(){V=D.val(),W=O.val(),j=L.val(),o(1)}),U.on("click",function(){window.location.reload()}),I.on("click",function(){var e=$(this),s=e.data("afsno");e.prop("disabled",!0),$.post(__BASEURL__+"mshop/afs_api/agree",autoCsrf({afsno:s}),function(s){s.success?(new Msg({type:"success",msg:"退款成功"}),o(Q)):new Msg({type:"danger",msg:s.msg}),e.prop("disabled",!1),T.modal("hide")})}),C.on("click",function(){T.modal("hide"),c()}),window.agreeOrder=p,window.refuseOrder=m,window.refundOrder=u,window.printOrder=_,window.simTakingOrder=f,window.simDeliveredOrder=l,window.confirmDelivered=w,window.rePushOrder=h,window.turnSellerDelivery=y,window.exportOrder=M,window.onMouseOut=a,window.onMouse=r});