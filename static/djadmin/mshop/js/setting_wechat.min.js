$(function(){var A=$('[name="login_type"]'),d=$("#app_nick_name"),k=$("#app_id"),W=$("#app_id_thirdparty"),t=$("#app_secret"),aa=$("#verify_file_name"),C=$("#verify_file_path"),E=$("#mch_id"),l=$("#key"),h=$('[name="auto_refund"]'),X=$("#apiclient_cert"),n=$("#apiclient_cert_path"),U=$("#apiclient_key"),Z=$("#apiclient_key_path"),s=$(".developer-box"),B=$(".thirdparty-box"),m=$("#auth-form"),H=$("#pay-form"),N=$("#refund-form"),c=$("#authModal"),T=$("#authResultModal"),i=$("#btn-auth-wechat"),b=$("#btn-auth-success"),D=$("#btn-edit-auth"),v=$("#btn-cancel-auth"),y=$("#btn-save-auth"),I=$("#btn-edit-pay"),F=$("#btn-cancel-pay"),z=$("#btn-save-pay"),ac=$("#btn-edit-refund"),ad=$("#btn-cancel-refund"),K=$("#btn-save-refund"),f=$("#auth-action-box"),M=$("#pay-action-box"),Y=$("#refund-action-box");
var G=null;g();S();q();a();V();u();P();j();function R(){m.find("fieldset").prop("disabled",false);D.hide();f.show();}function O(){m.find("fieldset").prop("disabled",true);
D.show();f.hide();}D.on("click",function(){r();R();});v.on("click",function(){r();O();});function x(){H.find("fieldset").prop("disabled",false);I.hide();
M.show();}function L(){H.find("fieldset").prop("disabled",true);I.show();M.hide();}I.on("click",function(){o();x();});F.on("click",function(){o();L();});
function p(){N.find("fieldset").prop("disabled",false);ac.hide();Y.show();}function J(){N.find("fieldset").prop("disabled",true);ac.show();Y.hide();}ac.on("click",function(){w();
p();});ad.on("click",function(){w();J();});function g(){var af=new Clipboard(".btn-copy");af.on("success",function(ag){new Msg({type:"success",msg:"复制成功",delay:1});
});af.on("error",function(ag){new Msg({type:"danger",msg:"复制失败",delay:1});});}function S(){var af=new plupload.Uploader({browse_button:"btn-verify-file",url:__BASEURL__+"common_file/upload?type=inc&http_url=1",flash_swf_url:__STATICURL__+"libs/plupload/2.3.1/Moxie.swf",file_data_name:"imgFile",auto_start:true,multi_selection:false,domain:__UPLOADURL__,filters:{mime_types:[{title:"Txt files",extensions:"txt"}]},init:{FileUploaded:function(ag,ai,aj){var ah=JSON.parse(aj.response);
aa.text(ai.name);C.val(ah.data.new_filepath);}}});af.init();af.bind("FilesAdded",function(ag,ah){af.start();});}function q(){var af=new plupload.Uploader({browse_button:"btn-apiclient-cert",url:__BASEURL__+"common_file/upload?type=inc&http_url=1",flash_swf_url:__STATICURL__+"libs/plupload/2.3.1/Moxie.swf",file_data_name:"imgFile",auto_start:true,multi_selection:false,domain:__UPLOADURL__,filters:{mime_types:[{title:"Pem files",extensions:"pem"}]},init:{FileUploaded:function(ag,ai,aj){var ah=JSON.parse(aj.response);
X.text(ai.name);n.val(ah.data.new_filepath);}}});af.init();af.bind("FilesAdded",function(ag,ah){af.start();});}function a(){var af=new plupload.Uploader({browse_button:"btn-apiclient-key",url:__BASEURL__+"common_file/upload?type=inc&http_url=1",flash_swf_url:__STATICURL__+"libs/plupload/2.3.1/Moxie.swf",file_data_name:"imgFile",auto_start:true,multi_selection:false,domain:__UPLOADURL__,filters:{mime_types:[{title:"Pem files",extensions:"pem"}]},init:{FileUploaded:function(ag,ai,aj){var ah=JSON.parse(aj.response);
U.text(ai.name);Z.val(ah.data.new_filepath);}}});af.init();af.bind("FilesAdded",function(ag,ah){af.start();});}function r(){m.data("bootstrapValidator").destroy();
m.data("bootstrapValidator",null);V();}function V(){m.bootstrapValidator({fields:{login_type:{validators:{notEmpty:{message:"请选择授权方式"}}},app_id:{validators:{notEmpty:{message:"AppID(公众号ID)不能为空"}}},app_secret:{validators:{notEmpty:{message:"AppSecret(公众号密钥)不能为空"}}},verify_file_name:{validators:{notEmpty:{message:"网页授权文件不能为空"}}},verify_file_path:{validators:{notEmpty:{message:"网页授权文件不能为空"}}}}}).on("success.form.bv",function(aj){aj.preventDefault();
var af=+$('[name="login_type"]:checked').val(),ah=k.val(),al=t.val(),ag=aa.text(),ai=C.val(),ak={login_type:af};if(af===0&&(!ag||!ai)){new Msg({type:"danger",msg:"网页授权文件不能为空"});
return;}if(af===0){ak.app_id=ah;ak.app_secret=al;ak.verify_file_name=ag;ak.verify_file_path=ai;}y.prop("disabled",true).text("保存中...");$.post(__BASEURL__+"mshop/gzh_config_api/login_edit",autoCsrf(ak),function(am){y.prop("disabled",false).text("保存");
if(am.success){r();O();new Msg({type:"success",msg:am.msg});}else{new Msg({type:"danger",msg:am.msg});}});});}function o(){H.data("bootstrapValidator").destroy();
H.data("bootstrapValidator",null);u();}function u(){H.bootstrapValidator({fields:{mch_id:{validators:{notEmpty:{message:"MCHID(商户ID)不能为空"}}},key:{validators:{notEmpty:{message:"key(商户支付秘钥)不能为空"}}}}}).on("success.form.bv",function(ah){ah.preventDefault();
var af=E.val(),ag=l.val();z.prop("disabled",true).text("保存中...");$.post(__BASEURL__+"mshop/gzh_config_api/pay_edit",autoCsrf({mch_id:af,key:ag}),function(ai){z.prop("disabled",false).text("保存");
if(ai.success){o();L();new Msg({type:"success",msg:ai.msg});}else{new Msg({type:"danger",msg:ai.msg});}});});}function w(){N.data("bootstrapValidator").destroy();
N.data("bootstrapValidator",null);P();}function P(){N.bootstrapValidator({fields:{apiclient_cert_path:{validators:{notEmpty:{message:"apiclient_cert(证书)不能为空"}}},apiclient_key_path:{validators:{notEmpty:{message:"apiclient_key(证书密钥)不能为空"}}}}}).on("success.form.bv",function(ah){ah.preventDefault();
var af=n.val(),ag=Z.val();if(!af){new Msg({type:"danger",msg:"apiclient_cert(证书)不能为空"});return;}if(!ag){new Msg({type:"danger",msg:"apiclient_key(证书密钥)不能为空"});
return;}K.prop("disabled",true).text("保存中...");$.post(__BASEURL__+"mshop/gzh_config_api/return_edit",autoCsrf({apiclient_cert_path:af,apiclient_key_path:ag}),function(ai){K.prop("disabled",false).text("保存");
if(ai.success){w();J();new Msg({type:"success",msg:ai.msg});}else{new Msg({type:"danger",msg:ai.msg});}});});}function e(){$('[name="login_type"][value="0"').prop("checked",true);
ae(0);}function j(){$.getJSON(__BASEURL__+"mshop/gzh_config_api/info",function(ai){if(ai.success){var aj=ai.data.info;G=ai.data.gzh_info;if(!aj){R();x();
p();e();return;}if(aj.login_type&&aj.login_type!=="null"){$('[name="login_type"][value='+aj.login_type+"]").prop("checked",true);ae(+aj.login_type);}else{e();
}aj.app_id&&(aj.app_id!=="null")&&k.val(aj.app_id);aj.app_secret&&(aj.app_secret!=="null")&&t.val(aj.app_secret);if(G){G.appid&&(G.appid!=="null")&&W.text(G.appid);
G.app_nick_name&&(G.app_nick_name!=="null")&&d.text(G.app_nick_name);}aj.verify_file_name&&(aj.verify_file_name!=="null")&&aa.text(aj.verify_file_name);
aj.verify_file_path&&(aj.verify_file_path!=="null")&&C.val(aj.verify_file_path);if(aj.app_id&&(aj.app_id!=="null")&&aj.app_secret&&(aj.app_secret!=="null")&&(aj.verify_file_name!=="null")&&aj.verify_file_path&&(aj.verify_file_path!=="null")){O();
}else{R();}aj.mch_id&&(aj.mch_id!=="null")&&E.val(aj.mch_id);aj.key&&(aj.key!=="null")&&l.val(aj.key);if(aj.mch_id&&(aj.mch_id!=="null")&&aj.key&&(aj.key!=="null")){L();
}else{x();}if(aj.is_auto_return!=="null"){Q(+aj.is_auto_return);if(+aj.is_auto_return==1){h.prop("checked",true);}else{h.prop("checked",false);}}if(aj.apiclient_cert_path&&aj.apiclient_cert_path!=="null"){var ag=aj.apiclient_cert_path;
var ak=ag.substr(ag.lastIndexOf("/")+1,ag.length);n.val(ag);X.text(ak);}if(aj.apiclient_key_path&&aj.apiclient_key_path!=="null"){var ah=aj.apiclient_key_path;
var af=ah.substr(ah.lastIndexOf("/")+1,ah.length);Z.val(ah);U.text(af);}if(aj.apiclient_cert_path&&(aj.apiclient_cert_path!=="null")&&aj.apiclient_key_path&&(aj.apiclient_key_path!=="null")){J();
}else{p();}if(+aj.login_type===1&&(!G||!G.appid)){c.modal("show");}}else{R();x();p();new Msg({type:"danger",msg:ai.msg});}});}function ab(){$.getJSON(__BASEURL__+"mshop/gzh_config_api/info",function(af){if(af.success){G=af.data.gzh_info;
if(G&&G.appid&&(G.appid!=="null")){$('[name="login_type"][value="1"').prop("checked",true);ae(1);W.text(G.appid);d.text(G.app_nick_name);y.click();new Msg({type:"success",msg:"授权成功"});
}else{new Msg({type:"danger",msg:"暂无授权信息"});}}else{new Msg({type:"danger",msg:af.msg});}});}function ae(af){if(af===1){s.hide();B.show();}else{s.show();
B.hide();}r();}A.on("change",function(){var af=+$(this).val();if(af===1){if(G&&G.appid&&(G.appid!=="null")){ae(af);}else{e();c.modal("show");}}else{ae(af);
}});function Q(af){if(af==1){N.show();}else{N.hide();}}h.on("change",function(){var af=+h.is(":checked");Q(af);h.prop("disabled",true);$.post(__BASEURL__+"mshop/gzh_config_api/set_return",autoCsrf({is_auto_return:af}),function(ag){h.prop("disabled",false);
if(ag.success){new Msg({type:"success",msg:ag.msg});}else{h.prop("checked",false);new Msg({type:"danger",msg:ag.msg});}});});i.on("click",function(){c.modal("hide");
T.modal("show");});b.on("click",function(){T.modal("hide");ab();});});