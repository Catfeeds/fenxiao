$(function(){function e(){$.getJSON(__BASEURL__+"mshop/xcx_meal_config_api/info",function(e){if(e.success){if(!e.data)return;p.html(template(g,{is_authorized:!0,app_nick_name:e.data.app_nick_name,domain:e.data.domain,info:e.data.info,use_status:e.data.use_status,xcx_server_info:e.data.xcx_server_info})),i(),o(),s(),r()}else{var a={is_authorized:!1,app_nick_name:"",domain:"",info:null,use_status:0,xcx_server_info:null};p.html(template(g,a)),"小程序未授权或授权过期"!==e.msg&&new Msg({type:"danger",msg:e.msg})}})}function a(){d.modal("show")}function t(){f.modal("show")}function n(){var e=$("#experience-qrcode");$.getJSON(__BASEURL__+"mshop/xcx_meal_config_api/getqrcode",function(a){a.success?(e.attr("src",a.data.qrurl),l.modal("show")):new Msg({type:"danger",msg:a.msg})})}function s(){var e=new plupload.Uploader({browse_button:"btn-upload-verify",url:__BASEURL__+"common_file/upload?type=inc&http_url=1",flash_swf_url:__STATICURL__+"libs/plupload/2.3.1/Moxie.swf",file_data_name:"imgFile",auto_start:!0,multi_selection:!1,domain:__UPLOADURL__,filters:{mime_types:[{title:"Txt files",extensions:"txt"}]},init:{FileUploaded:function(e,a,t){var n=JSON.parse(t.response),s=n.data.new_filepath;e.getOption("domain")+s;$("#verify_file_name").text(a.name),$("#verify_file_path").val(s)}}});e.init(),e.bind("FilesAdded",function(a,t){e.start()})}function i(){$("#config-form").bootstrapValidator({fields:{app_secreat:{validators:{notEmpty:{message:"appsecrer不能为空"}}}}}).on("success.form.bv",function(e){e.preventDefault();var a=$("#btn-save-config"),t=$("#app_id").val();app_secreat=$("#app_secreat").val(),a.prop("disabled",!0),$.post(__BASEURL__+"mshop/xcx_meal_config_api/save_secreat",autoCsrf({app_id:t,app_secreat:app_secreat}),function(e){e.success?new Msg({type:"success",msg:e.msg,delay:1}):new Msg({type:"danger",msg:e.msg}),a.prop("disabled",!1)})})}function o(){$("#verify-form").bootstrapValidator({fields:{verify_file_path:{validators:{notEmpty:{message:"校验文件不能为空"}}}}}).on("success.form.bv",function(e){e.preventDefault();var a=$("#btn-save-verify"),t=$("#app_id").val(),n=$("#verify_file_name").text(),s=$("#verify_file_path").val();a.prop("disabled",!0),$.post(__BASEURL__+"mshop/xcx_meal_config_api/save_verify_file",autoCsrf({app_id:t,verify_file_name:n,verify_file_path:s}),function(e){e.success?new Msg({type:"success",msg:e.msg,delay:1}):new Msg({type:"danger",msg:e.msg}),a.prop("disabled",!1)})})}function r(){var e=new Clipboard(".btn-copy");e.on("success",function(e){new Msg({type:"success",msg:"复制成功",delay:1})}),e.on("error",function(e){new Msg({type:"danger",msg:"复制失败",delay:1})})}function _(e){var a=new Date(1e3*parseInt(e)),t=a.getFullYear(),n=a.getMonth()+1,s=a.getDate(),i=a.getHours(),o=a.getMinutes(),r=a.getSeconds(),_=t+"-"+c(n)+"-"+c(s)+" "+c(i)+":"+c(o)+":"+c(r);return _}function c(e){return parseInt(e)<10&&(e="0"+e),e}var p=$("#xcx-info"),l=$("#qrcodeModal"),f=$("#generateModal"),d=$("#authModal"),u=$("#btn-confirm-generate"),m=$("#btn-confirm-auth"),g=document.getElementById("xcxTpl").innerHTML;e(),m.on("click",function(){d.modal("hide"),e()}),u.on("click",function(){u.prop("disabled",!0),$.getJSON(__BASEURL__+"mshop/xcx_meal_config_api/generate",function(a){a.success?new Msg({type:"success",msg:a.msg,delay:1,callback:function(){e()}}):new Msg({type:"danger",msg:a.msg}),u.prop("disabled",!1),f.modal("hide")})}),window.authXcx=a,window.generateXcx=t,window.experienceXcx=n,window.formateTime=_});