$(function(){var u=$("#active_id").val(),i=$("#btn-confirm"),m=$("#addGoodModal"),s=$("#active_name"),b=$("#start_time"),r=$("#end_time"),f=$("#shop");
var q=1,d=10,c="",j=true,l=true;var h=document.getElementById("setDiscountTpl").innerHTML;var e={list:[]};if(!u){$("#discountTbody").html(template(h,e));
}else{o();}function o(){$.getJSON(__BASEURL__+"mshop/promotion_api/detail",{id:u},function(w){if(w.success){var v=w.data;console.log(v);s.val(v.title);
b.val(v.start_time.alias);r.val(v.end_time.alias);e.list=JSON.parse(v.setting);c=v.shop_id;$("#shop option[value='"+c+"']").attr("selected","selected");
$("#discountTbody").html(template(h,e));}});}function p(){var w;var v;w={elem:"#start_time",format:"yyyy-MM-dd HH:mm:ss",theme:"#5aa2e7",type:"datetime",istime:true,istoday:false,choose:function(x){v.min=x;
v.start=x;},done:function(y,x,z){v.min=y;v.start=y;console.log(v);}};v={elem:"#end_time",format:"yyyy-MM-dd HH:mm:ss",max:"2099-06-16 23:59:59",min:"",start:"",type:"datetime",istime:true,istoday:false,theme:"#5aa2e7",choose:function(x){w.max=x;
},done:function(y,x,z){w.max=y;}};laydate.render(w);laydate.render(v);}p();function n(){var y=null;var v=null;function x(z){if(!z){v=moment(new Date());
}else{v=z;}$('input[name="from"]').daterangepicker({autoApply:true,singleDatePicker:true,showDropdowns:true,timePicker:true,timePicker24Hour:true,timePickerSeconds:false,opens:"center",showWeekNumbers:true,locale:{format:"YYYY-MM-DD",applyLabel:"确定",cancelLabel:"取消",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],firstDay:1},},function(A){w(A);
});}x();function w(z){$('input[name="to"]').daterangepicker({autoApply:true,singleDatePicker:true,showDropdowns:true,timePicker:true,timePicker24Hour:true,timePickerSeconds:false,minDate:z,opens:"center",showWeekNumbers:true,locale:{format:"YYYY-MM-DD HH:mm:ss",applyLabel:"确定",cancelLabel:"取消",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],firstDay:1},},function(A){x(A);
});}}function g(){var v={};v.price="";v.red_price="";if(e.list.length>=3){new Msg({type:"danger",msg:"最多添加3个优惠设置"});}else{e.list.push(v);$("#discountTbody").html(template(h,e));
}}function a(x,v){for(var w=0;w<e.list.length;w++){if(v==w){e.list.splice(w,1);}}$("#discountTbody").html(template(h,e));}function t(y,w){var v=$(y).val();
if(v==""){new Msg({type:"danger",msg:"订单金额输入框不能为空"});j=false;}else{j=true;}for(var x=0;x<e.list.length;x++){if(w==x){e.list[x].price=v;}}$("#discountTbody").html(template(h,e));
}function k(y,w){var v=$(y).val();if(v==""){new Msg({type:"danger",msg:"减免金额输入框不能为空"});l=false;}else{l=true;}for(var x=0;x<e.list.length;x++){if(w==x){e.list[x].red_price=v;
}}$("#discountTbody").html(template(h,e));}$("#discount-form").bootstrapValidator({fields:{active_name:{validators:{notEmpty:{message:"活动名称不能为空"},stringLength:{max:30,message:"活动名称不得超过30个字符"}}},order_price:{validators:{notEmpty:{message:"订单金额不能为空"}}}}}).on("success.form.bv",function(D){D.preventDefault();
var A=s.val(),B=b.val(),w=r.val();var x=(B.replace(/-/g,"/"));var C=new Date(w.replace(/-/g,"/"));var E=parseInt(C.getTime())-(new Date(x).getTime());if(E<=0){new Msg({type:"danger",msg:"结束时间不能小于开始时间"});
return false;}var z=$('[name="order_price"]');var v=$('[name="red_price"]');z.each(function(F,G){if($(G).val()==""){new Msg({type:"danger",msg:"请填写订单金额"});
j=false;return false;}});v.each(function(F,G){if($(G).val()==""){new Msg({type:"danger",msg:"请填写减免金额"});l=false;return false;}});if(B==""||w==""){new Msg({type:"danger",msg:"请填写活动时间"});
return false;}if(e.list.length==0){new Msg({type:"danger",msg:"请添加订单优惠"});return false;}var y=true;e.list.forEach(function(F){if(Number(F.price)<=Number(F.red_price)){y=false;
}});if(!y){new Msg({type:"danger",msg:"订单金额必须大于减免金额"});return false;}c=f.find("option:selected").val();if(c==""){new Msg({type:"danger",msg:"请先选择门店"});
return false;}post_data={shop_id:c,type:2,title:A,start_time:B,end_time:w,discount_type:1,limit_buy:0,limit_times:0,goods_arr:"",setting:JSON.stringify(e.list)};
if(!u){post_url=__BASEURL__+"mshop/promotion_api/create";}else{post_data.id=u;post_url=__BASEURL__+"mshop/promotion_api/edit";}if(j&&l){i.prop("disabled",true);
$.post(post_url,autoCsrf(post_data),function(F){if(F.success){new Msg({type:"success",msg:F.msg,delay:1,callback:function(){window.location.href=__BASEURL__+"mshop/promotion/activity_list";
}});}else{new Msg({type:"danger",msg:F.msg});}i.prop("disabled",false);});}else{if(!j){new Msg({type:"danger",msg:"请填写订单金额"});}if(!l){new Msg({type:"danger",msg:"请填写减免金额"});
}}});window.addGood=g;window.delPrice=a;window.orderPriceChange=t;window.redPriceChange=k;});