$(function(){function e(){var e=new qq.maps.LatLng(39.916527,116.397128),t="http://chaxun.1616.net/s.php?type=ip&output=json&callback=?&_="+Math.random();w=new qq.maps.Map(document.getElementById("map-container"),{center:e,zoom:15}),X=new qq.maps.Marker({map:w}),$.getJSON(t,function(e){e.Ip&&f.searchCityByIP(e.Ip)}),f=new qq.maps.CityService({map:w,complete:function(e){w.setCenter(e.detail.latLng)}}),y=new qq.maps.Geocoder({complete:function(e){w.setCenter(e.detail.location),X.setMap(null),X=new qq.maps.Marker({map:w,position:e.detail.location}),se=e.detail.location.lat,ae=e.detail.location.lng,j.val(e.detail.location.lat+","+e.detail.location.lng)}})}function t(){var e=$("#shop_state option:selected").data("name"),t=$("#shop_city option:selected").data("name"),i=$("#shop_district option:selected").data("name"),a=I.val(),s=e+t+i+a;y.getLocation(s)}function i(){$.getJSON(__BASEURL__+"/mshop/shop_api/info",{shop_id:k},function(e){if(e.success){var t=e.data.info;Y=t.use_flow,Z=t.auto_receiver,ee=t.auto_printer,ie=t.shipping_fee,ie&&(ie=JSON.parse(ie),M.val(ie["0_1000"]),q.val(ie["1000_3000"]),O.val(ie["3000_5000"]),U.val(ie["5000_"])),le=+t.type,o(),1==Y?$('[value="满"]').attr("checked",!0):$('[value="满"]').attr("checked",!1),1==Z?$('[value="自动接单"]').prop("checked",!0):$('[value="自动接单"]').prop("checked",!1),1==ee?$('[value="自动打单"]').prop("checked",!0):$('[value="自动打单"]').prop("checked",!1),ne=t.shop_imgs.split(","),pe.list=[];for(var i=0;i<ne.length;i++)pe.list.push({pic:ne[i]});pe.list.length<3&&t.shop_imgs&&pe.list.push({pic:""}),s(),T.val(pe.list[0].pic).blur(),z.val(t.prepare_time),se=t.latitude,ae=t.longitude,X.setPosition(new qq.maps.LatLng(se,ae)),oe=t.on_time;for(var a=t.on_time.split("|"),n=0;n<a.length;n++){var l=a[n].split("-");de.list.push({startTime:l[0],endTime:l[1]})}d(),r(),_();var p=t.region?t.region.split("-"):new Array(3),c=p[0]||0,m=p[1]||0,h=p[2]||0,g=t.shop_logo,u=g.indexOf("http")>-1?g:__UPLOADURL__+g;x.areapicker({provinceField:"shop_state",cityField:"shop_city",areaField:"shop_district",province:c,city:m,area:h});var v=t.shop_state+t.shop_city+t.shop_district+t.shop_address;y.getLocation(v),L.val(t.shop_name),S.val(g),A.val(t.send_money),F.val(t.flow_free_money),B.val(t.service_radius),R.val(t.arrive_time),N.val(t.arrive_range),I.val(t.shop_address),H.val(t.notice),D.val(t.contact),Q.find(".upload-again").show(),Q.find(".upload-pic").attr("src",u)}else new Msg({type:"danger",msg:e.msg})})}function a(){$.getJSON(__BASEURL__+"mshop/shop_api/main_shop_info",{main_shop_id:E},function(e){if(e.success){var t=e.data.info;se=t.latitude,ae=t.longitude,X.setPosition(new qq.maps.LatLng(se,ae));var i=t.region?t.region.split("-"):new Array(3),a=i[0]||0,s=i[1]||0,o=i[2]||0;x.areapicker({provinceField:"shop_state",cityField:"shop_city",areaField:"shop_district",province:a,city:s,area:o});var n=t.shop_logo,l=n.indexOf("http")>-1?n:__UPLOADURL__+n,p=t.shop_state+t.shop_city+t.shop_district+t.shop_address;y.getLocation(p),L.val(t.shop_name),S.val(n),I.val(t.shop_address),D.val(t.contact),Q.find(".upload-again").show(),Q.find(".upload-pic").attr("src",l)}else new Msg({type:"danger",msg:e.msg})})}function s(){$("#logoTbody").html(template(K,pe)),n()}function o(){var e=$('[name="service"][value="1"]'),t=$('[name="service"][value="2"]'),i=$('[name="service"][value="4"]');(1&le)>0&&(e.length>0?(e.prop("checked",!0),G.show()):le-=1),(2&le)>0&&(t.length>0?t.prop("checked",!0):le-=2),(4&le)>0&&(i.length>0?i.prop("checked",!0):le-=4)}function n(){$(".upload-inputs").each(function(e,t){var i=($(this),$(this).parent(".m-upload")),a=$(this).parents(".logo-item-good"),o=$(this).attr("id"),n=i.attr("id");uploadFile("wsc_goods",{browse_button:o,container:n,drop_element:n,max_file_size:"1mb",chunk_size:"1mb",init:{FileUploaded:function(t,o,n){var l=t.getOption("domain"),p=JSON.parse(n.response),d=l+p.key;i.find(".good-logo").val(p.key).blur(),i.addClass("m-upload-good"),i.find(".upload-again").show(),i.find(".upload-plus").hide(),i.find(".upload-pic").attr("src",d),pe.list[e].pic=p.key,T.val(pe.list[0].pic).blur(),0!=a.length||pe.list.length<3&&pe.list.push({pic:""}),s()}}})})}function l(e,t){T.val(pe.list[0].pic).blur(),3==pe.list.length&&""!=pe.list[2].pic?(pe.list.splice(t,1),pe.list.push({pic:""})):pe.list.splice(t,1),s()}function p(){uploadFile("main_header",{browse_button:"upload-logo",container:"upload-logo-container",drop_element:"upload-logo-container",max_file_size:"1mb",chunk_size:"1mb",init:{FileUploaded:function(e,t,i){var a=JSON.parse(i.response),s=a.key,o=e.getOption("domain")+s;S.val(s).blur(),Q.find(".upload-again").show(),Q.find(".upload-plus").hide(),Q.find(".upload-pic").attr("src",o)}}})}function d(){$("#timeList").html(template(W,de))}function r(){for(var e=0;e<de.list.length;e++)$("#datetimeStart"+e).datetimepicker({datepicker:!1,format:"H:i",step:5}),$("#datetimeEnd"+e).datetimepicker({datepicker:!1,format:"H:i",step:5}),de.list[e].startTime=$("#datetimeStart"+e).val(),de.list[e].endTime=$("#datetimeEnd"+e).val()}function c(){var e={startTime:"23:59",endTime:"06:00"},t=$(".time-view");return t.length>=3?(new Msg({type:"danger",msg:"最多只能添加3个时间段"}),!1):(de.list.push(e),d(),r(),_(),void 0)}function m(e){for(var t=0;t<de.list.length;t++)e==t&&de.list.splice(t,1);d(),r(),_()}function _(){for(var e=0;e<de.list.length;e++)$("#datetimeStart"+e).blur(function(){}),$("#datetimeEnd"+e).blur(function(){}),$("#datetimeStart0").blur(function(){de.list[0].startTime=$("#datetimeStart0").val()}),$("#datetimeEnd0").blur(function(){de.list[0].endTime=$("#datetimeEnd0").val()}),$("#datetimeStart1").blur(function(){de.list[1].startTime=$("#datetimeStart1").val()}),$("#datetimeEnd1").blur(function(){de.list[1].endTime=$("#datetimeEnd1").val()}),$("#datetimeStart2").blur(function(){de.list[2].startTime=$("#datetimeStart2").val()}),$("#datetimeEnd2").blur(function(){de.list[2].endTime=$("#datetimeEnd2").val()})}function h(e){Z=$(e).is(":checked")?1:0}function g(e){ee=$(e).is(":checked")?1:0}function u(){var e=$('[name="service"]:checked');le=0,e.each(function(e,t){le+=Number(t.value)}),(1&le)>0?G.show():G.hide()}function v(){"1"==b?window.location.href=__BASEURL__+"mshop/shop":window.location.href=__BASEURL__+"mshop/shop/info/"+k}var f,y,w,E=GetQueryString("main_shop_id")||"",k=$("#shop_id").val(),b=$("#is_admin").val(),L=$("#shop_name"),S=$("#shop_logo"),T=$("#good_logo"),M=$("#shipping_distance1"),q=$("#shipping_distance2"),O=$("#shipping_distance3"),U=$("#shipping_distance4"),A=$("#shop_startPrice"),F=$("#full_dispatchPrice"),B=$("#shop_radius"),R=$("#shop_sendTime"),N=$("#shop_area"),x=$("#shop_region"),P=$("#shop_state"),C=$("#shop_city"),J=$("#shop_district"),I=$("#shop_address"),z=$("#prepare_time"),j=$("#shop_location"),H=$("#notice"),D=$("#contact"),G=$(".waimai-box"),Q=$("#upload-logo-container"),V=$("#btn-confirm"),K=document.getElementById("logoTpl").innerHTML,W=document.getElementById("timeTpl").innerHTML,X=null,Y=1,Z=1,ee=1,te="",ie="",ae="",se="",oe=[],ne=[],le=0,pe={list:[{}]},de={list:[]};e(),k?i():(s(),E?a():x.areapicker({provinceField:"shop_state",cityField:"shop_city",areaField:"shop_district"})),I.on("blur",function(){t()}),p(),d(),r(),_(),$("#shop-form").bootstrapValidator({fields:{shop_name:{validators:{notEmpty:{message:"门店名称不能为空"},stringLength:{max:30,message:"门店名称不得超过30个字符"}}},shop_logo:{validators:{notEmpty:{message:"请上传门店logo"}}},good_logo:{validators:{notEmpty:{message:"请上传门店图片"}}},shop_startPrice:{validators:{notEmpty:{message:"起送价不能为空"}}},shipping_distance1:{validators:{notEmpty:{message:"配送费不能为空"}}},shipping_distance2:{validators:{notEmpty:{message:"配送费不能为空"}}},shipping_distance3:{validators:{notEmpty:{message:"配送费不能为空"}}},shipping_distance4:{validators:{notEmpty:{message:"配送费不能为空"}}},shop_radius:{validators:{notEmpty:{message:"服务半径不能为空"}}},shop_sendTime:{validators:{notEmpty:{message:"预计送达时间不能为空"}}},shop_state:{validators:{notEmpty:{message:"选择省份"}}},shop_city:{validators:{notEmpty:{message:"选择城市"}}},shop_district:{validators:{notEmpty:{message:"选择地区"}}},shop_address:{validators:{notEmpty:{message:"详细地址不能为空"}}},shop_location:{validators:{notEmpty:{message:"经纬度不能为空，请先完善门店地址"}}},notice:{validators:{notEmpty:{message:"门店公告不能为空"},stringLength:{max:140,message:"门店公告不得超过140个字符"}}},contact:{validators:{notEmpty:{message:"联系电话不能为空"},phone:{country:"CN",message:"联系电话格式不正确"}}},send_type:{validators:{notEmpty:{message:"配送方式不能为空"}}}}}).on("success.form.bv",function(e){e.preventDefault();var t,i,a,s,o=L.val(),n=S.val(),l=T.val(),p=D.val(),d=M.val(),r=q.val(),c=O.val(),m=U.val(),_=A.val(),h=F.val(),g=B.val(),u=z.val()||0,v=R.val(),f=N.val(),y=P.find(":selected").data("name"),w=P.find(":selected").data("code"),x=C.find(":selected").data("name"),j=C.find(":selected").data("code"),G=J.find(":selected").data("name"),Q=J.find(":selected").data("code"),K=I.val(),W=H.val();switch(h){case"":h="";break;case"0":h="";break;case"0.00":h=""}i=new Array(w,j,Q).join("-"),$('[value="满"]').is(":checked")?(Y=1,te=h):(Y=0,te=0),Z=$('[value="自动接单"]').is(":checked")?1:0,ee=$('[value="自动打单"]').is(":checked")?1:0,ne.splice(0,ne.length);for(var X=0;X<pe.list.length;X++)pe.list[X].pic&&ne.push(pe.list[X].pic);if(t={"0_1000":d,"1000_3000":r,"3000_5000":c,"5000_":m},(1&le)<=0&&(2&le)<=0&&(4&le)<=0)return new Msg({type:"danger",msg:"请选择门店服务"}),!1;if(le&!0){if(_<0)return new Msg({type:"danger",msg:"起送价要大于等于0"}),!1;if(g<=0)return new Msg({type:"danger",msg:"服务半径要大于0"}),!1;if($('[value="满"]').is(":checked")&&""==h)return new Msg({type:"danger",msg:"请填写免配送费"}),!1;if(""==l)return new Msg({type:"danger",msg:"请上传商品主图"}),!1}oe=[];for(var X=0;X<de.list.length;X++)oe.push(de.list[X].startTime+"-"+de.list[X].endTime);s={shop_name:o,shop_logo:n,contact:p,send_money:_,shipping_fee:JSON.stringify(t),use_flow:Y,flow_free_money:te,service_radius:g,arrive_time:v,arrive_range:f,prepare_time:u,shop_imgs:ne.join(","),notice:W,longitude:ae,latitude:se,shop_state:y,shop_city:x,shop_district:G,shop_address:K,region:i,on_time:oe.join("|"),auto_receiver:Z,auto_printer:ee,type:le},k?(s.shop_id=k,a=__BASEURL__+"mshop/shop_api/edit/"+k):(E&&(s.main_shop_id=E),a=__BASEURL__+"mshop/shop_api/add"),V.prop("disabled",!0),$.post(a,autoCsrf(s),function(e){e.success?new Msg({type:"success",msg:e.msg,delay:1,callback:function(){"1"==b?window.location.href=__BASEURL__+"mshop/shop":window.location.href=__BASEURL__+"mshop/shop/info/"+k}}):new Msg({type:"danger",msg:e.msg}),V.prop("disabled",!1)})}),window.delLogo=l,window.addTime=c,window.delTime=m,window.Return=v,window.isMakeOrder=g,window.changeStatus=h,window.changeService=u});