$(function(){var p=$("#active_id").val(),I=$("#shop"),w=$("#start_time"),J=$("#end_time"),E=$("#btn-confirm"),G=$("#addGoodModal"),A=$("#active_name"),M=$("#discount_num");
var K=1,H=10,f=0,s=0,b=1,h="",a=true,v=true;var j=document.getElementById("addGoodTpl").innerHTML,c=document.getElementById("goodsTpl").innerHTML;var l=[];
var y=[];var n=[];var q={list:[]};var x={list:[]};if(!p){if(b==1){$("#shopTbody").html(template(c,q));}else{$("#shopTbody").html(template(c,x));}}else{i();
}function i(){$.getJSON(__BASEURL__+"mshop/promotion_api/detail",{id:p},function(Q){if(Q.success){var P=Q.data;A.val(P.title);w.val(P.start_time.alias);
J.val(P.end_time.alias);h=P.shop_id;$("#shop option[value='"+h+"']").attr("selected","selected");f=P.limit_buy;s=P.limit_times;if(f==0){$('[value="不限购"]').attr("checked",true);
}else{$('[value="限购"]').attr("checked",true);M.val(f);}if(s==0){$('[value="不限次数"]').attr("checked",true);}else{$('[value="仅限1次"]').attr("checked",true);
}b=P.discount_type.value;if(b==1){$('[value="打折"]').attr("checked",true);q.list=JSON.parse(P.setting);$("#shopTbody").html(template(c,q));}else{$('[value="减价"]').attr("checked",true);
x.list=JSON.parse(P.setting);$("#shopTbody").html(template(c,x));}l=P.goods_arr.split(",");}});}function C(){function P(Q,R){time=Q.format("YYYY-MM-DD")+" - "+R.format("YYYY-MM-DD");
$time.val(time);}$time.daterangepicker({startDate:startTime,endDate:end,applyClass:"btn-primary",cancelClass:"btn-default",locale:{applyLabel:"确认",cancelLabel:"取消",fromLabel:"起始时间",toLabel:"结束时间",customRangeLabel:"自定义",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],firstDay:1,format:"YYYY-MM-DD"},ranges:{}},P);
}function B(){var Q;var P;Q={elem:"#start_time",format:"yyyy-MM-dd HH:mm:ss",theme:"#5aa2e7",type:"datetime",done:function(S,R,T){P.min=S;P.start=S;}};
P={elem:"#end_time",format:"yyyy-MM-dd HH:mm:ss",max:"2099-06-16 23:59:59",min:"",type:"datetime",theme:"#5aa2e7",choose:function(R){Q.max=R;Q.min=min;
},done:function(S,R,T){}};laydate.render(Q);laydate.render(P);}B();o(K);function o(P,R,Q){h=h;if(h!=0){$.getJSON(__BASEURL__+"mshop/items_api/goods_list",{current_page:P||1,page_size:H,cate_id:R,title:Q,shop_id:h},function(T){if(T.success){var S=Math.ceil(+T.data.total/H);
$("#goodModal").html(template(j,T.data));laypage({cont:"goodModalPage",pages:S,curr:P||1,skin:"#5aa2e7",first:1,last:S,skip:true,prev:"&lt",next:"&gt",jump:function(U,V){if(!V){o(U.curr);
}}});}});}else{$.getJSON(__BASEURL__+"mshop/store_goods_api/goods_list",{current_page:P||1,page_size:H,},function(T){if(T.success){var S=Math.ceil(+T.data.total/H);
$("#goodModal").html(template(j,T.data));laypage({cont:"goodModalPage",pages:S,curr:P||1,skin:"#5aa2e7",first:1,last:S,skip:true,prev:"&lt",next:"&gt",jump:function(U,V){if(!V){o(U.curr);
}}});}});}}function u(){var P=$("#searchModalVal").val(),Q=undefined;o(K,Q,P);}function z(P){if($(P).val()=="不限购"){f=0;}else{f=M.val();}}function D(P){if($(P).val()=="不限次数"){s=0;
}else{s=1;}}function e(P){if($(P).val()=="打折"){b=1;$("#shopTbody").html(template(c,q));}else{b=2;$("#shopTbody").html(template(c,x));}}function t(){var P=I.find("option:selected").val();
if(P!=h){q={list:[]};x={list:[]};}h=I.find("option:selected").val();if(h==""){new Msg({type:"danger",msg:"请先选择门店"});return false;}if(b==1){}else{}G.modal("show");
o(K);$('[name="selectAll"]').prop("checked",false);}function O(T){var S=$(T),R=$('[name="selectItem"]:checked'),P=[];goodIds="";var Q=I.find("option:selected").val();
if(R.length<1){new Msg({type:"danger",msg:"请先选择商品"});return false;}if(Q==0){$.each(R,function(U){var W=$(this);var X=$(this).val();var V=[];$.getJSON(__BASEURL__+"/mshop/store_goods_api/goods_ids_list",{goods_ids:X},function(ac){if(ac.success){V=ac.data[0].sku_list;
for(var Y=0;Y<V.length;Y++){V[Y].decPrice="";}var ab={};ab.id=W.val();ab.name=W.data("title");ab.src=W.data("path");ab.price=W.data("price");ab.dec_price=0;
ab.dec_input="";ab.good_stock="";ab.sku_list=V;if(b==1){ab.discount_name="打折";}else{ab.discount_name="减价";}for(var aa=0;aa<q.list.length;aa++){if(W.val()==q.list[aa].id){new Msg({type:"danger",msg:"商品已选择。请选择别的商品"});
return false;}}for(var Z=0;Z<x.list.length;Z++){if(W.val()==x.list[Z].id){new Msg({type:"danger",msg:"商品已选择。请选择别的商品"});return false;}}if(b==1){q.list.push(ab);
}else{x.list.push(ab);}P.push(W.val());if(b==1){if(q.list.length<=0){}else{l=P;G.modal("hide");$("#shopTbody").html(template(c,q));}}else{if(x.list.length<=0){}else{l=P;
G.modal("hide");$("#shopTbody").html(template(c,x));}}if(b==1){$("#shopTbody").html(template(c,q));}else{$("#shopTbody").html(template(c,x));}G.modal("hide");
}});});}else{$.each(R,function(U){var W=$(this);var X=$(this).val();var V=[];$.getJSON(__BASEURL__+"/mshop/items_api/goods_ids_list",{goods_ids:X},function(ac){if(ac.success){V=ac.data[0].sku_list;
for(var Y=0;Y<V.length;Y++){V[Y].decPrice="";}var ab={};ab.id=W.val();ab.name=W.data("title");ab.src=W.data("path");ab.price=W.data("price");ab.dec_price=0;
ab.dec_input="";ab.good_stock="";ab.sku_list=V;if(b==1){ab.discount_name="打折";}else{ab.discount_name="减价";}for(var aa=0;aa<q.list.length;aa++){if(W.val()==q.list[aa].id){new Msg({type:"danger",msg:"商品已选择。请选择别的商品"});
return false;}}for(var Z=0;Z<x.list.length;Z++){if(W.val()==x.list[Z].id){new Msg({type:"danger",msg:"商品已选择。请选择别的商品"});return false;}}if(b==1){q.list.push(ab);
}else{x.list.push(ab);}P.push(W.val());if(b==1){if(q.list.length<=0){}else{l=P;G.modal("hide");$("#shopTbody").html(template(c,q));}}else{if(x.list.length<=0){}else{l=P;
G.modal("hide");$("#shopTbody").html(template(c,x));}}if(b==1){$("#shopTbody").html(template(c,q));}else{$("#shopTbody").html(template(c,x));}G.modal("hide");
}});});}}function N(U,Q,T,S){var R=[];var P=I.find("option:selected").val();if(P==0){$.getJSON(__BASEURL__+"/mshop/store_goods_api/goods_ids_list",{goods_ids:U},function(Z){if(Z.success){R=Z.data[0].sku_list;
for(var V=0;V<R.length;V++){R[V].decPrice="";}var Y={};Y.id=U;Y.name=S;Y.src=T;Y.price=Q;Y.dec_price=0;Y.dec_input="";Y.good_stock="";Y.sku_list=R;if(b==1){Y.discount_name="打折";
}else{Y.discount_name="减价";}for(var X=0;X<q.list.length;X++){if(U==q.list[X].id){new Msg({type:"danger",msg:"商品已选择。请选择别的商品"});return false;}}for(var W=0;
W<x.list.length;W++){if(U==x.list[W].id){new Msg({type:"danger",msg:"商品已选择。请选择别的商品"});return false;}}if(b==1){q.list.push(Y);}else{x.list.push(Y);}l.push(U);
if(b==1){$("#shopTbody").html(template(c,q));}else{$("#shopTbody").html(template(c,x));}G.modal("hide");}});}else{$.getJSON(__BASEURL__+"/mshop/items_api/goods_ids_list",{goods_ids:U},function(Z){if(Z.success){R=Z.data[0].sku_list;
for(var V=0;V<R.length;V++){R[V].decPrice="";}var Y={};Y.id=U;Y.name=S;Y.src=T;Y.price=Q;Y.dec_price=0;Y.dec_input="";Y.good_stock="";Y.sku_list=R;if(b==1){Y.discount_name="打折";
}else{Y.discount_name="减价";}for(var X=0;X<q.list.length;X++){if(U==q.list[X].id){new Msg({type:"danger",msg:"商品已选择。请选择别的商品"});return false;}}for(var W=0;
W<x.list.length;W++){if(U==x.list[W].id){new Msg({type:"danger",msg:"商品已选择。请选择别的商品"});return false;}}if(b==1){q.list.push(Y);}else{x.list.push(Y);}l.push(U);
if(b==1){$("#shopTbody").html(template(c,q));}else{$("#shopTbody").html(template(c,x));}G.modal("hide");}});}}function k(P){$(".hover_table"+P).toggle();
}function r(P){}function F(P){}var d=function(P){var R=parseFloat(P);if(isNaN(R)){return"0";}var R=Math.round(P*100)/100;var Q=R.toString();return Q;};
function m(Q,P,T,S,U){var X=$(Q).val();if(!/^\d*(\.\d{1,2})?$/.test(X)){new Msg({type:"danger",msg:"只能输入数字和小数点"});a=false;}else{a=true;}if(X==""){new Msg({type:"danger",msg:"输入框不能为空"});
v=false;}else{v=true;}if(U=="打折"){if(X==0){new Msg({type:"danger",msg:"打折率不能为0"});E.prop("disabled",true);return false;}else{E.prop("disabled",false);}if(/^[1-9](\.\d+)?$/.test(X)){E.prop("disabled",false);
}else{new Msg({type:"danger",msg:"打折率只能为1到10的以内的非负数"});E.prop("disabled",true);return false;}}else{var V=S.indexOf("~");if(V>0){var W=S.substring(0,V);
var R=S.substring(V+1,S.length);if(parseFloat(X)>parseFloat(W)){new Msg({type:"danger",msg:"减价不能超出原价"});E.prop("disabled",true);return false;}else{E.prop("disabled",false);
}}else{if(parseFloat(X)>=parseFloat(S)){new Msg({type:"danger",msg:"减价不能超出原价"});E.prop("disabled",true);return false;}else{E.prop("disabled",false);}}}$.getJSON(__BASEURL__+"/mshop/items_api/goods_ids_list",{goods_ids:P},function(ab){if(ab.success){var ae=[];
ae=ab.data[0].sku_list;var ah=$(Q).val();var ac="";var ad="";if(ae.length>1){for(var Y=0;Y<ae.length;Y++){if(U=="打折"){ac=parseFloat(ae[Y].sale_price)*parseFloat(ah*0.1);
ae[Y].decPrice=d(ac);}else{ac=parseFloat(ae[Y].sale_price)-ah;ae[Y].decPrice=d(ac);}}var af=S.indexOf("~");if(af>0){var ag=S.substring(0,af);var aa=S.substring(af+1,S.length);
if(U=="打折"){ag=d(parseFloat(ag)*parseFloat((ah*0.1)));aa=d(parseFloat(aa)*parseFloat((ah*0.1)));ad=ag.toString()+"~"+aa.toString();}else{ag=d(parseFloat(ag)-ah);
aa=d(parseFloat(aa)-ah);ad=ag.toString()+"~"+aa.toString();}}else{if(U=="打折"){ad=d(parseFloat(S)*parseFloat((ah*0.1)));}else{ad=d(parseFloat(S)-ah);}}if(b==1){for(var Z=0;
Z<q.list.length;Z++){if(T==Z){q.list[Z].dec_price=(ad);q.list[Z].sku_list=ae;q.list[Z].dec_input=d(ah*0.1);}}$("#shopTbody").html(template(c,q));}else{for(var Z=0;
Z<x.list.length;Z++){if(T==Z){x.list[Z].dec_price=(ad);x.list[Z].sku_list=ae;x.list[Z].dec_input=ah;}}$("#shopTbody").html(template(c,x));}}else{if(U=="打折"){ac=parseFloat(S)*parseFloat(ah*0.1);
}else{ac=parseFloat(S)-ah;}if(b==1){for(var Z=0;Z<q.list.length;Z++){if(T==Z){q.list[Z].dec_price=d(ac);q.list[Z].dec_input=d(ah*0.1);}}$("#shopTbody").html(template(c,q));
}else{for(var Z=0;Z<x.list.length;Z++){if(T==Z){x.list[Z].dec_price=d(ac);x.list[Z].dec_input=ah;}}$("#shopTbody").html(template(c,x));}}}});}function g(S,Q){var P=$(S).val();
if(b==1){for(var R=0;R<q.list.length;R++){if(Q==R){q.list[R].good_stock=P;}}$("#shopTbody").html(template(c,q));}else{for(var R=0;R<x.list.length;R++){if(Q==R){x.list[R].good_stock=P;
}}$("#shopTbody").html(template(c,x));}}function L(P){if(b==1){for(var Q=0;Q<q.list.length;Q++){if(P==Q){q.list.splice(Q,1);}}$("#shopTbody").html(template(c,q));
}else{for(var Q=0;Q<x.list.length;Q++){if(P==Q){x.list.splice(Q,1);}}$("#shopTbody").html(template(c,x));}}$("#discount-form").bootstrapValidator({fields:{active_name:{validators:{notEmpty:{message:"活动名称不能为空"},stringLength:{max:30,message:"活动名称不得超过30个字符"}}},shop_id:{validators:{notEmpty:{message:"门店不能为空"}}},dec_input:{validators:{notEmpty:{message:"优惠输入框不能为空"}}}}}).on("success.form.bv",function(X){X.preventDefault();
var U=A.val(),V=w.val(),Q=J.val(),P=M.val();switch(P){case"":P="";break;case"0":P="";break;case"0.00":P="";break;}var R=(V.replace(/-/g,"/"));var W=new Date(Q.replace(/-/g,"/"));
var Z=parseInt(W.getTime())-(new Date(R).getTime());if(Z<=0){new Msg({type:"danger",msg:"结束时间不能小于开始时间"});return false;}if($('[value="限购"]').is(":checked")){f=M.val();
}else{f=0;}if($('[value="仅限1次"]').is(":checked")){s=1;}else{s=0;}if($('[value="限购"]').is(":checked")&&P==""){new Msg({type:"danger",msg:"请填写限购件数"});return false;
}if($('[value="限购"]').is(":checked")&&P<=0){new Msg({type:"danger",msg:"限购件数必须大于0"});return false;}if(V==""||Q==""){new Msg({type:"danger",msg:"请填写活动时间"});
return false;}var Y=$(".dec_input");Y.each(function(ab,ac){var aa=$(ac).val();if(b==1){q.list[ab].dec_input=d(aa*0.1);}else{x.list[ab].dec_input=aa;}if(aa==""){new Msg({type:"danger",msg:"请填写优惠价格"});
a=false;return false;}});if(b==1&&q.list.length==0){new Msg({type:"danger",msg:"请添加打折商品"});return false;}if(b==2&&x.list.length==0){new Msg({type:"danger",msg:"请添加减价商品"});
return false;}h=I.find("option:selected").val();if(h==""){new Msg({type:"danger",msg:"请先选择门店"});return false;}post_data={shop_id:h,title:U,type:1,start_time:V,end_time:Q,discount_type:b,limit_buy:f,limit_times:s,setting:JSON.stringify(q.list),goods_arr:l.join(",")};
if(b==1){post_data.setting=JSON.stringify(q.list);for(var T=0;T<q.list.length;T++){y.push(q.list[T].id);}post_data.goods_arr=y.join(",");}else{post_data.setting=JSON.stringify(x.list);
for(var S=0;S<x.list.length;S++){n.push(x.list[S].id);}post_data.goods_arr=n.join(",");}if(!p){post_url=__BASEURL__+"mshop/promotion_api/create";}else{post_data.id=p;
post_url=__BASEURL__+"mshop/promotion_api/edit";}if(a&&v){E.prop("disabled",true);$.post(post_url,autoCsrf(post_data),function(aa){if(aa.success){new Msg({type:"success",msg:aa.msg,delay:1,callback:function(){window.location.href=__BASEURL__+"mshop/promotion/discount_list";
}});}else{new Msg({type:"danger",msg:aa.msg});}E.prop("disabled",false);});}else{new Msg({type:"danger",msg:"只能输入数字和小数点"});}});window.onshowTable=k;window.addGood=t;
window.selectGood=N;window.goodType=e;window.discountType=z;window.limitType=D;window.searchModalVal=u;window.batchAddGood=O;window.editPrice=m;window.delgood=L;
window.onMouseOutSku=r;window.onMouseSku=F;});