$(function(){var g=$("#shop"),E=$("#editCateModal"),j=$("#delCateModal"),y=$("#edit-confirm"),o=$("#addGoodModal"),C=$("#del-confirm"),A=$("#cate_name"),w=$("#cate_sort"),q=$("#title"),r=$("#btn-search"),u=$('[name="selectAll"]'),c=$("#goodTbody"),B=document.getElementById("cateTpl").innerHTML,d=document.getElementById("goodTpl").innerHTML;
var z=1,n=1,f=10,F=q.val(),b=[],e=g.val(),x="";i();D();$("body").on("click",'[name="selectAll"]',function(){if($(this).is(":checked")){var H=$('[name="selectItem"]:checked');
$.each(H,function(I){if(b.indexOf($(this).val())<0){b.push($(this).val());}});}else{var G=$('[name="selectItem"]');$.each(G,function(J){var I=b.indexOf($(this).val());
if(I>-1){b.splice(I,1);}});}});$("body").on("click",'[name="selectItem"]',function(){if($(this).is(":checked")){if(b.indexOf($(this).val())<0){b.push($(this).val());
}}else{var G=b.indexOf($(this).val());if(G>-1){b.splice(G,1);}}});function i(G){$.getJSON(__BASEURL__+"mshop/items_api/cate_list",{shop_id:e,current_page:G||1,page_size:f},function(I){if(I.success){var H=Math.ceil(+I.data.total/f);
$("#cateTbody").html(template(B,I.data));laypage({cont:"catePage",pages:H,curr:G||1,skin:"#5aa2e7",first:1,last:H,skip:true,prev:"&lt",next:"&gt",jump:function(J,K){if(!K){i(J.curr);
z=J.curr;}}});}});}function t(I){var G,H={current_page:I||1,page_size:f,title:F};if(e!=="0"){G=__BASEURL__+"mshop/items_api/goods_list";H.shop_id=e;}else{G=__BASEURL__+"mshop/store_goods_api/goods_list";
}$.getJSON(G,H,function(M){if(M.success){var K=Math.ceil(+M.data.total/f);M.data.rows.forEach(function(O,N){if(b.indexOf(O.id)>-1){M.data.rows[N].is_check=true;
}});c.html(template(d,{rows:M.data.rows,cate_id:x}));var L=$('[name="selectItem"]').length,J=$('[name="selectItem"]:checked').length;if(L!==0){if(L==J){$('[name="selectAll"]').prop("checked",true);
}else{$('[name="selectAll"]').prop("checked",false);}}laypage({cont:"goodPage",pages:K,curr:I||1,skin:"#5aa2e7",first:1,last:K,skip:true,prev:"&lt",next:"&gt",jump:function(N,O){if(!O){t(N.curr);
n=N.curr;}}});}});}function p(G){x=G;c.html('<tr><td class="text-center" colspan="3">加载中...</td></tr>');u.prop("checked",false);o.modal("show");b=[];t(1);
}function h(J,H){var I=$(J),G,K={cate_id:x,goods_ids:H};if(e!=="0"){G=__BASEURL__+"mshop/items_api/cate_goods_add";K.shop_id=e;}else{G=__BASEURL__+"mshop/store_goods_api/cate_goods_add";
}I.prop("disabled",true);$.post(G,autoCsrf(K),function(L){if(L.success){new Msg({type:"success",msg:"添加成功"});u.prop("checked",false);b=[];t(n);}else{new Msg({type:"danger",msg:L.msg});
}I.prop("disabled",false);});}function m(G){if(b.length<1){new Msg({type:"danger",msg:"请先选择商品"});return false;}h(G,b.join(","));}function v(I,K){var H=$(I),J={cate_id:x,goods_id:K},G;
if(e!=="0"){G=__BASEURL__+"mshop/items_api/cate_goods_remove";J.shop_id=e;}else{G=__BASEURL__+"mshop/store_goods_api/cate_goods_remove";}H.prop("disabled",true);
$.post(G,autoCsrf(J),function(L){if(L.success){new Msg({type:"success",msg:"移除成功"});t(n);}else{new Msg({type:"danger",msg:L.msg});}H.prop("disabled",false);
});}function k(){E.modal("show");$("#cate-form").data("bootstrapValidator").destroy();$("#cate-form").data("bootstrapValidator",null);D();}function s(){k();
E.find(".modal-title").text("添加分类");A.val("");w.val("");y.data("id","");}function l(I,G,H){k();E.find(".modal-title").text("编辑分类");A.val(G);w.val(H);y.data("id",I);
}function a(G){j.modal("show");C.data("id",G);}function D(){$("#cate-form").bootstrapValidator({fields:{cate_name:{validators:{notEmpty:{message:"分类名称不能为空"},stringLength:{max:8,message:"分类名称不得超过8个字符"}}},cate_sort:{validators:{notEmpty:{message:"分类排序不能为空"}}}}}).on("success.form.bv",function(J){J.preventDefault();
var H=A.val(),I=w.val(),L=y.data("id"),G,K;K={shop_id:e,cate_name:H,sort:I};if(!L){G=__BASEURL__+"mshop/items_api/cate_add";}else{K.id=L;G=__BASEURL__+"mshop/items_api/cate_edit";
}y.prop("disabled",true);$.post(G,autoCsrf(K),function(M){if(M.success){new Msg({type:"success",msg:M.msg});i(z);}else{new Msg({type:"danger",msg:M.msg});
}y.prop("disabled",false);E.modal("hide");});});}C.on("click",function(){var G=$(this).data("id");C.prop("disabled",true);$.post(__BASEURL__+"mshop/items_api/cate_del",autoCsrf({id:G}),function(H){if(H.success){new Msg({type:"success",msg:"删除成功"});
i(1);}else{new Msg({type:"danger",msg:H.msg});}C.prop("disabled",false);j.modal("hide");});});g.on("change",function(){e=$(this).val();i(1);});r.on("click",function(){F=q.val();
t(1);});window.addCate=s;window.editCate=l;window.delCate=a;window.openGoodModal=p;window.addGood=h;window.batchAddGood=m;window.delGood=v;});