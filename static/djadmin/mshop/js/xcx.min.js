$(function(){function e(){$.getJSON(__BASEURL__+"mshop/xcx_config_api/info",function(e){if(e.success){if(!e.data)return;r.html(template(f,{is_authorized:!0,app_nick_name:e.data.app_nick_name,domain:e.data.domain,info:e.data.info,use_status:e.data.use_status,xcx_server_info:e.data.xcx_server_info})),i(),s()}else{var t={is_authorized:!1,app_nick_name:"",domain:"",info:null,use_status:0,xcx_server_info:null};r.html(template(f,t)),"小程序未授权或授权过期"!==e.msg&&new Msg({type:"danger",msg:e.msg})}})}function t(){d.modal("show")}function n(){p.modal("show")}function a(){var e=$("#experience-qrcode");$.getJSON(__BASEURL__+"mshop/xcx_config_api/getqrcode",function(t){t.success?(e.attr("src",t.data.qrurl),_.modal("show")):new Msg({type:"danger",msg:t.msg})})}function s(){var e=new plupload.Uploader({browse_button:"btn-upload-verify",url:__BASEURL__+"common_file/upload?type=inc&http_url=1",flash_swf_url:__STATICURL__+"libs/plupload/2.3.1/Moxie.swf",file_data_name:"imgFile",auto_start:!0,multi_selection:!1,domain:__UPLOADURL__,filters:{mime_types:[{title:"Txt files",extensions:"txt"}]},init:{FileUploaded:function(e,t,n){var a=JSON.parse(n.response),s=a.data.new_filepath;e.getOption("domain")+s;$("#verify_file_name").text(t.name),$("#verify_file_path").val(s)}}});e.init(),e.bind("FilesAdded",function(t,n){e.start()})}function i(){$("#config-form").bootstrapValidator({fields:{app_secreat:{validators:{notEmpty:{message:"appsecrer不能为空"}}}}}).on("success.form.bv",function(e){e.preventDefault();var t=$("#btn-save-config"),n=$("#app_id").val();app_secreat=$("#app_secreat").val(),t.prop("disabled",!0),$.post(__BASEURL__+"mshop/xcx_config_api/save_secreat",autoCsrf({app_id:n,app_secreat:app_secreat}),function(e){e.success?new Msg({type:"success",msg:e.msg,delay:1}):new Msg({type:"danger",msg:e.msg}),t.prop("disabled",!1)})})}function o(e){var t=new Date(1e3*parseInt(e)),n=t.getFullYear(),a=t.getMonth()+1,s=t.getDate(),i=t.getHours(),o=t.getMinutes(),r=t.getSeconds(),_=n+"-"+c(a)+"-"+c(s)+" "+c(i)+":"+c(o)+":"+c(r);return _}function c(e){return parseInt(e)<10&&(e="0"+e),e}var r=$("#xcx-info"),_=$("#qrcodeModal"),p=$("#generateModal"),d=$("#authModal"),l=$("#btn-confirm-generate"),u=$("#btn-confirm-auth"),f=document.getElementById("xcxTpl").innerHTML;e(),u.on("click",function(){d.modal("hide"),e()}),l.on("click",function(){l.prop("disabled",!0),$.getJSON(__BASEURL__+"mshop/xcx_config_api/generate",function(t){t.success?new Msg({type:"success",msg:t.msg,delay:1,callback:function(){e()}}):new Msg({type:"danger",msg:t.msg}),l.prop("disabled",!1),p.modal("hide")})}),window.authXcx=t,window.generateXcx=n,window.experienceXcx=a,window.formateTime=o});