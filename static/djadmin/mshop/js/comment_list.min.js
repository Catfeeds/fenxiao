$(function(){var h=$("#create_time"),q=$("#edit-confirm"),t=$("#editReplyModal"),l=echarts.init(document.getElementById("data-trend-chart")),m=document.getElementById("commentTpl").innerHTML;
var i=moment().subtract(29,"days"),f=moment();var r=1,g=10,d=0,j="",s="",x="",o="",b=i.format("YYYY-MM-DD")+" - "+f.format("YYYY-MM-DD");w();c();function w(){function y(z,B,A){b=z.format("YYYY-MM-DD")+" - "+B.format("YYYY-MM-DD");
if(A=="自定义"){A=b;}console.info(A);$("#comment-time").html(A);h.val(b);c(1);}h.daterangepicker({startDate:i,endDate:f,maxDate:f,applyClass:"btn-primary",cancelClass:"btn-default",locale:{applyLabel:"确认",cancelLabel:"取消",fromLabel:"起始时间",toLabel:"结束时间",customRangeLabel:"自定义",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],firstDay:1,format:"YYYY-MM-DD"},ranges:{今日:[moment(),moment()],昨日:[moment().subtract(1,"days"),moment().subtract(1,"days")],最近7日:[moment().subtract(6,"days"),moment()],最近30日:[moment().subtract(29,"days"),moment()]}},y);
}function e(D,K,y,J,I){var H=Number(D)+Number(K)+Number(y)+Number(J)+Number(I);var G=(Number(D)/H*100).toFixed(2);var B=(Number(K)/H*100).toFixed(2);var A=(Number(y)/H*100).toFixed(2);
var F=(Number(J)/H*100).toFixed(2);var E=(Number(I)/H*100).toFixed(2);console.info(G);if(isNaN(G)){G=0;}if(isNaN(B)){B=0;}if(isNaN(A)){A=0;}if(isNaN(F)){F=0;
}if(isNaN(E)){E=0;}var z=[G,B,A,F,E];var C=100;option={tooltip:{show:true,formatter:"{b} {c}"},grid:{left:"15%",top:"0",bottom:"0",right:"15%"},xAxis:[{max:C,type:"value",axisTick:{show:false,},axisLine:{show:false,},axisLabel:{show:false},splitLine:{show:false}}],yAxis:[{type:"category",data:["一星","二星","三星","四星","五星"],nameTextStyle:{color:"#b7ce9e",fontSize:"18px"},axisTick:{show:false,},axisLine:{show:false,}}],series:[{name:" ",type:"bar",barWidth:10,silent:true,itemStyle:{normal:{color:"#f2f2f2"}},label:{normal:{show:true,position:"right",formatter:function(L){return z[L.dataIndex]+"%";
},color:["#475669"]}},barGap:"-100%",barCategoryGap:"50%",data:z.map(function(L){return C;}),},{name:" ",type:"bar",barWidth:10,data:[{value:G,itemStyle:{normal:{color:"#59a2e7"}}},{value:B,itemStyle:{normal:{color:"#59a2e7"}}},{value:A,itemStyle:{normal:{color:"#59a2e7"}}},{value:F,itemStyle:{normal:{color:"#59a2e7"}}},{value:E,itemStyle:{normal:{color:"#59a2e7"}}}],markLine:{label:{normal:{show:true,position:"end",formatter:"{b}{c}%"}},lineStyle:{normal:{color:"#525d63"}}}}]};
l.setOption(option);}function c(y){$.getJSON(__BASEURL__+"mshop/comment_api/comment_list",{shop_id:d,current_page:y||1,page_size:g,time:b,reply_type:j,score:s,is_have:o,tag:x},function(D){if(D.success){var z=Math.ceil(+D.data.total/g);
var E={rows:[],comment_tag:[],is_comment:true};E.comment_tag=D.data.comment_tag;E.rows=D.data.rows;for(var C=0;C<D.data.rows.length;C++){if(D.data.rows[C].comments[0].tags){E.rows[C].comments[0].tags=D.data.rows[C].comments[0].tags.split(",");
}else{E.rows[C].comments[0].tags=[];}if(D.data.rows[C].comments[0].picarr){E.rows[C].comments[0].picarr=D.data.rows[C].comments[0].picarr.split(",");for(var A=0;
A<E.rows[C].comments[0].picarr.length;A++){if(E.rows[C].comments[0].picarr[A]){if(E.rows[C].comments[0].picarr[A].indexOf("http")>-1){E.rows[C].comments[0].picarr[A]=E.rows[C].comments[0].picarr[A];
}else{E.rows[C].comments[0].picarr[A]=__UPLOADURL__+E.rows[C].comments[0].picarr[A];}}else{E.rows[C].comments[0].picarr[A]=[];}}}else{E.rows[C].comments[0].picarr=[];
}}for(var B=0;B<E.comment_tag.length;B++){E.comment_tag[B].is_active=false;if(x==E.comment_tag[B].id){E.comment_tag[B].is_active=true;E.is_comment=false;
}}$("#commentTbody").html(template(m,E));$("#score-one").html(D.data.score.score_one_count);$("#score-two").html(D.data.score.score_two_count);$("#score-three").html(D.data.score.score_three_count);
$("#score-four").html(D.data.score.score_four_count);$("#score-five").html(D.data.score.score_five_count);$("#reply-rate").html(D.data.reply_rate+"%");
$("#low-reply-rate").html(D.data.low_score_reply_rate+"%");one=D.data.score.score_one_count;two=D.data.score.score_two_count;three=D.data.score.score_three_count;
four=D.data.score.score_four_count;five=D.data.score.score_five_count;e(one,two,three,four,five);laypage({cont:"commentPage",pages:z,curr:y||1,skin:"#5aa2e7",first:1,last:z,skip:true,prev:"&lt",next:"&gt",jump:function(F,G){if(!G){c(F.curr);
r=F.curr;}}});}});}$("body").on("click",'[name="commentTpye"]',function(){var y=$(this).val();$(this).prop("checked",true);if(y==0){j="";}else{if(y==1){j=1;
}}c(1);});$("body").on("click",".label-primary",function(){var y=$(this).attr("data-id");$(this).addClass("active");$(this).siblings().removeClass("active");
x=y;c(1);});$("body").on("click",'[name="hasContent"]',function(){if($(this).is(":checked")){o=1;}else{o="";}c(1);});function k(y){a();$("#reply_name").val("");
q.data("id",y);}function a(){t.modal("show");$("#reply-form").data("bootstrapValidator").destroy();$("#reply-form").data("bootstrapValidator",null);n();
}n();function n(){$("#reply-form").bootstrapValidator({fields:{reply_name:{validators:{notEmpty:{message:"回复内容不能为空"}}}}}).on("success.form.bv",function(z){z.preventDefault();
var B=q.data("id"),y=$("#reply_name").val(),A;A={order_id:B,content:y};post_url=__BASEURL__+"mshop/comment_api/reply";q.prop("disabled",true);$.post(post_url,autoCsrf(A),function(C){if(C.success){new Msg({type:"success",msg:C.msg});
c(r);}else{new Msg({type:"danger",msg:C.msg});}q.prop("disabled",false);t.modal("hide");});});}function v(z,y){$.post(__BASEURL__+"mshop/comment_api/hide",autoCsrf({order_id:z,is_hide:y}),function(A){if(A.success){new Msg({type:"success",msg:A.msg});
c(1);}else{new Msg({type:"danger",msg:A.msg});}});}function p(y){var z=$(y).find("input").val();j=z;c(1);}function u(y){var z=$(y).find("input").val();
s=z;c(1);}window.changeScore=u;window.changeReply=p;window.changeHide=v;window.reply=k;});