$(function(){var y=document.getElementById("classTpl").innerHTML,C=document.getElementById("manyTpl").innerHTML;var f=$("#goods_id").val(),i=$("#shop_id").val(),o=$("#good_title"),L=$("#good_code"),p=$("#good_price"),S=$("#good_member"),ac=$("#good_detail"),an=$("#good_box"),O=$("#good_stock"),J=$("#editCateModal"),ae=$("#editImgModal"),af=$("#edit-confirm"),U=$("#cate_name"),s=$("#cate_sort"),W=$("#count-weight"),ag=$("#btn-confirm");
var K=document.getElementById("logoTpl").innerHTML,l=document.getElementById("propTpl").innerHTML;var R=0,ad="",u="",Q=[],h=[],ak=0,H=1,r={list:[]},V={list:[{pic:""}]},w={list:[]};
if(!f){F();G();m(i);}else{G();al();}function G(){$("#logoTbody").html(template(K,V));e();if($("#good-form").data("bootstrapValidator")){$("#good-form").data("bootstrapValidator").destroy();
$("#good-form").data("bootstrapValidator",null);F();}}function m(aq){$.getJSON(__BASEURL__+"mshop/items_api/get_all_cate",{shop_id:aq},function(au){if(au.success){var at={rows:au.data};
$("#classTbody").html(template(y,at));if(h){for(var ar=0;ar<h.length;ar++){$(".cate-label[data-value='"+h[ar]+"']").addClass("active");}}}});}function al(){$.getJSON(__BASEURL__+"mshop/items_api/goods_info",{goods_id:f},function(at){if(at.success){V.list=[];
if(at.data.picarr){var aq=at.data.picarr.split(",");aq.forEach(function(au){if(au){V.list.push({pic:au});}});}else{V.list.push({pic:at.data.pict_url});
}if(V.list.length!=5){V.list.push({pic:""});}G();if(at.data.pro_attrs){w.list=at.data.pro_attrs;}if(w.list.length>0){$(".prop-group").hide();$("#prop").show();
$("#propTbody").html(template(l,w));}o.val(at.data.title);ac.val(at.data.description);L.val(at.data.goods_sn);h=at.data.cate_ids.split(",");i=at.data.shop_id;
m(i);if(at.data.measure_type==1){H=1;$('[name="goodMetering"][value="1"]').prop("checked",true);}else{H=2;$('[name="goodMetering"][value="2"]').prop("checked",true);
W.show();$("#count-weight option[value='"+at.data.unit_type+"']").attr("selected",true);M();}if(at.data.tag==0){$('[name="goodLabel"][value="0"]').prop("checked",true);
}else{if(at.data.tag==1){$('[name="goodLabel"][value="1"]').prop("checked",true);}else{$('[name="goodLabel"][value="2"]').prop("checked",true);}}if(at.data.sku_type==0){R=0;
p.val(at.data.inner_price);S.val(at.data.sku[0].member_price);an.val(at.data.sku[0].box_fee);ad=at.data.sku[0].id;if(at.data.sku[0].use_stock_num<0){$('[name="goodStock"][value="0"]').prop("checked",true);
}else{$('[name="goodStock"][value="1"]').prop("checked",true);O.show();O.val(at.data.sku[0].use_stock_num);}}else{R=1;Q=[];$("#many").show();$("#only-type-box").hide();
for(var ar=0;ar<at.data.sku.length;ar++){r.list.push({sku_name:at.data.sku[ar].attr_names,box:at.data.sku[ar].box_fee,sku_code:at.data.sku[ar].goods_sku_sn,member_price:at.data.sku[ar].member_price,price:at.data.sku[ar].sale_price,sku_id:at.data.sku[ar].id,stock:at.data.sku[ar].use_stock_num});
if(at.data.sku[ar].use_stock_num<0){r.list[ar].is_stock=false;r.list[ar].stock="";}else{r.list[ar].is_stock=true;}}$("#manyTbody").html(template(C,r));
}Z();$('[name="good_stock"]').each(function(){var au=parseFloat($(this).val())||0;$(this).val(au);});ah();F();}else{new Msg({type:"danger",msg:at.msg});
}});}function e(){$(".upload-input").each(function(aq,ar){$(this).on("click",function(){$(this).val("");});$(this).on("change",function(av){var au=/\.(jpg|png|JPG|PNG)$/;
if(!au.test(av.target.value)){new Msg({type:"danger",msg:"请上传jpg、png格式图片"});return;}var at=new FileReader();at.onload=function(aw){B.imgSrc=aw.target.result;
ae.modal("show");$("#upload-logo").val("");A.setValue(0);N=$(".imageBox").cropbox(B);};at.readAsDataURL(this.files[0]);u=aq;});});}function v(ar,aq){if(V.list.length==5){if(V.list[4].pic!=""){V.list.splice(aq,1);
V.list.push({pic:""});}else{V.list.splice(aq,1);}}else{V.list.splice(aq,1);}G();}var B={thumbBox:".thumbBox",spinner:".spinner",imgSrc:""};var N=$(".imageBox").cropbox(B);
var A=new Slider("#ex1",{formatter:function(ar){var aq=ar/20+1;N.zoomChange(aq);return"Current value: "+ar;}});$("#btnCrop").on("click",function(){var aq=N.getDataURL();
var ar=g(aq);if(ar.size>1024*1024){new Msg({type:"danger",msg:"请上传小于1M的图片"});return;}ao(ar,u);});$("#btnZoomIn").on("click",function(){N.zoomIn();});$("#btnZoomOut").on("click",function(){N.zoomOut();
});function ao(ar,aq){$.getJSON(__BASEURL__+"qiniu_api/get_token",{type:"wsc_goods"},function(av,at){if(av.success){upload_url=av.data.upload_url;up_token=av.data.up_token;
var aw=new FormData();var au="wsc_goods/"+new Date().getTime()+"_"+Math.floor(1000+Math.random()*(9999-1000))+".png";aw.append("file",ar);aw.append("key",au);
aw.append("token",up_token);$.ajax({url:upload_url,type:"post",processData:false,contentType:false,data:aw,dataType:"json",success:function(ay,aB,aD){var aA=aD.responseJSON;
var ax=aA.key;var aC=__UPLOADURL__+ax;V.list[aq].pic=ax;$("#good_logo0").val(ax).blur();var az=V.list.length;if(az<5){if(V.list[az-1].pic){V.list.push({pic:""});
}}G();ae.modal("hide");},error:function(ax,az,ay){}});}});}function g(ar){var aq=window.atob(ar.split(",")[1]);var av=new ArrayBuffer(aq.length);var at=new Uint8Array(av);
for(var au=0;au<aq.length;au++){at[au]=aq.charCodeAt(au);}return new Blob([av],{type:"image/png"});}function am(aq){return $(aq).val();}function T(){r.list.push({sku_name:"",price:"",box:"",stock:"",is_stock:false});
$("#many").show();$("#only-type-box").hide();$("#good-form").data("bootstrapValidator").destroy();$("#good-form").data("bootstrapValidator",null);$("#manyTbody").html(template(C,r));
Z();R=1;F();ah();}function ah(){if(ak){$(".good_member").each(function(){$(this).prop("disabled",false);});}else{$(".good_member").each(function(){$(this).prop("disabled",true);
});}}function d(){r.list.push({sku_name:"",price:"",box:"",stock:"",is_stock:false});$("#good-form").data("bootstrapValidator").destroy();$("#good-form").data("bootstrapValidator",null);
$("#manyTbody").html(template(C,r));Z();F();ah();}function Z(){if(H==1){$(".good_stock").each(function(){$(this).attr("name","good_stock");});}else{$(".good_stock").each(function(){$(this).attr("name","good_stock2");
});}}function b(aq){if(r.list.length==1){r.list.splice(aq,1);$("#many").hide();$("#only-type-box").show();R=0;$("#good-form").data("bootstrapValidator").destroy();
$("#good-form").data("bootstrapValidator",null);Z();F();}else{r.list.splice(aq,1);$("#good-form").data("bootstrapValidator").destroy();$("#good-form").data("bootstrapValidator",null);
$("#manyTbody").html(template(C,r));Z();F();ah();}}function X(){if(w.list.length>4){new Msg({type:"danger",msg:"商品属性最多5条"});return;}w.list.push({name:"",value:["",""]});
$("#prop").show();$(".prop-group").hide();$("#good-form").data("bootstrapValidator").destroy();$("#good-form").data("bootstrapValidator",null);$("#propTbody").html(template(l,w));
F();}function t(){w.list.push({name:"",value:["",""]});$("#good-form").data("bootstrapValidator").destroy();$("#good-form").data("bootstrapValidator",null);
$("#propTbody").html(template(l,w));F();}function n(aq){if(w.list[aq].value.length>4){new Msg({type:"danger",msg:"商品属性内容最多5条"});return;}w.list[aq].value.push("");
$("#good-form").data("bootstrapValidator").destroy();$("#good-form").data("bootstrapValidator",null);$("#propTbody").html(template(l,w));F();}function c(aq){if(w.list[aq].value.length<3){new Msg({type:"danger",msg:"商品属性内容最少2条"});
return;}w.list[aq].value.pop();$("#good-form").data("bootstrapValidator").destroy();$("#good-form").data("bootstrapValidator",null);$("#propTbody").html(template(l,w));
F();}function k(aq){if(w.list.length==1){w.list.splice(aq,1);$("#prop").hide();$(".prop-group").show();}else{w.list.splice(aq,1);}$("#good-form").data("bootstrapValidator").destroy();
$("#good-form").data("bootstrapValidator",null);$("#propTbody").html(template(l,w));F();}function F(){$("#good-form").bootstrapValidator({fields:{good_title:{validators:{notEmpty:{message:"商品标题不能为空"},stringLength:{max:60,message:"商品标题不得超过60个字符"}}},cate_ids:{validators:{notEmpty:{message:"选择商品分类"}}},good_logo0:{validators:{notEmpty:{message:"请上传商品logo"}}},good_price:{validators:{notEmpty:{message:"商品价格不能为空"},regexp:{regexp:/^[+]{0,1}(\d+)$|^[+]{0,1}(\d+\.\d+)$/,message:"请输入正数"}}},good_member:{validators:{notEmpty:{message:"会员价不能为空"},regexp:{regexp:/^[+]{0,1}(\d+)$|^[+]{0,1}(\d+\.\d+)$/,message:"请输入正数"}}},sku_name:{validators:{notEmpty:{message:"规格名称不能为空"}}},good_box:{validators:{regexp:{regexp:/^[+]{0,1}(\d+)$|^[+]{0,1}(\d+\.\d+)$/,message:"请输入正数"}}},good_stock:{validators:{notEmpty:{message:"商品库存不能为空"},regexp:{regexp:/^[+]{0,1}(\d+)$/,message:"请输入正整数"}}},good_stock2:{validators:{notEmpty:{message:"商品库存不能为空"},regexp:{regexp:/^[+]{0,1}(\d+)$|^[+]{0,1}(\d+\.\d+)$/,message:"请输入正数"}}},good_detail:{validators:{stringLength:{max:80,message:"商品标题不得超过80个字符"}}},prop_name:{validators:{notEmpty:{message:"属性名称不能为空"}}},prop_value:{validators:{notEmpty:{message:"属性内容不能为空"}}}}}).on("success.form.bv",function(aG){aG.preventDefault();
var au=o.val(),aA=[],aK=$('[name="goodLabel"]:checked').val(),aL=0,ax=L.val(),aF=p.val(),aE=ac.val(),ay=an.val(),aw=O.val(),az=true,aC;if(ay==""){ay=0;
}if($('[name="goodStock"]:checked').val()==0){aw=-1;}var av=[{sku_attr:[{attr:"商品规格",value:""}],goods_sku_sn:"",box_fee:ay,sale_price:aF,use_stock_num:aw,sku_id:ad}];
var at=[];for(var aD=0;aD<r.list.length;aD++){var aM=r.list[aD].sku_name;Q.push(r.list[aD].sku_name);if(r.list[aD].box==""){r.list[aD].box=0;}if(!r.list[aD].is_stock){r.list[aD].stock=-1;
}at.push({sku_attr:[{attr:"商品规格",value:aM}],goods_sku_sn:r.list[aD].sku_code,box_fee:r.list[aD].box,sale_price:r.list[aD].price,use_stock_num:r.list[aD].stock,sku_id:r.list[aD].sku_id});
}var ar=[{attr_name:"商品规格",value:[""]}];var aq=[{attr_name:"商品规格",value:Q}];h=[];$(".cate-label.active").each(function(){h.push($(this).attr("data-value"));
});if(h.length==0){new Msg({type:"danger",msg:"请选择商品分类"});return false;}for(var aD=0;aD<w.list.length;aD++){var aH=w.list[aD].value;for(var aJ=0;aJ<aH.length;
aJ++){for(var aI=aJ+1;aI<aH.length;aI++){if(aH[aJ]==aH[aI]){new Msg({type:"danger",msg:"一个属性名下属性内容不能相同"});az=false;}}}for(var aB=aD+1;aB<w.list.length;
aB++){if(w.list[aD].name==w.list[aB].name){new Msg({type:"danger",msg:"属性名不能相同"});az=false;}}}if(!az){return false;}h=h.toString();V.list.forEach(function(aN){if(aN.pic){aA.push(aN.pic);
}});if(H==1){aL=0;}else{aL=$("#count-weight option:selected").val();}if(R==0){aC={shop_id:i,goods_id:f,title:au,picarr:aA.join(","),sku_type:R,tag:aK,description:aE,attr:JSON.stringify(ar),sku:JSON.stringify(av),cate_ids:h,goods_sn:ax,measure_type:H,unit_type:aL,pro_attrs:JSON.stringify(w.list)};
}else{aC={shop_id:i,goods_id:f,title:au,picarr:aA.join(","),sku_type:R,tag:aK,description:aE,attr:JSON.stringify(aq),sku:JSON.stringify(at),cate_ids:h,goods_sn:ax,measure_type:H,unit_type:aL,pro_attrs:JSON.stringify(w.list)};
}if(!f){post_url=__BASEURL__+"mshop/items_api/goods_add";}else{post_url=__BASEURL__+"mshop/items_api/goods_edit";}ag.prop("disabled",true);$.post(post_url,autoCsrf(aC),function(aN){if(aN.success){new Msg({type:"success",msg:aN.msg,delay:1,});
window.location.href=__BASEURL__+"mshop/items/index";}else{new Msg({type:"danger",msg:aN.msg});ag.prop("disabled",false);}});});}function aj(ar,aq){var at=$(ar).val();
r.list[aq].sku_name=at;}function ab(ar,aq){var at=$(ar).val();r.list[aq].sku_code=at;}function I(ar,aq){var at=$(ar).val();r.list[aq].price=at;}function q(ar,aq){var at=$(ar).val();
r.list[aq].member_price=at;}function z(ar,aq){var at=$(ar).val();r.list[aq].box=at;}function aa(ar,aq){var at=$(ar).val();r.list[aq].stock=at;}function E(ar,aq){var at=$(ar).val();
w.list[aq].name=at;}function j(at,ar,aq){var au=$(at).val();w.list[ar].value[aq]=au;}function P(aq){if($(aq).hasClass("active")){$(aq).removeClass("active");
}else{$(aq).addClass("active");}}function x(aq){$("#good-form").data("bootstrapValidator").destroy();$("#good-form").data("bootstrapValidator",null);F();
if($(aq).is(":checked")){is_member=true;$(".good_member").each(function(){$(this).prop("disabled",false);});}else{is_member=false;$(".good_member").each(function(){$(this).prop("disabled",true);
});}}function ap(aq){var ar=$(aq).val();if(ar==="2"){H=2;W.show();$(".input-group-weight").each(function(){$(this).html("元/kg");});$(".good_stock").each(function(){$(this).attr("name","good_stock2");
});}else{H=1;W.hide();$(".input-group-weight").each(function(){$(this).html("元");});$(".good_stock").each(function(){$(this).attr("name","good_stock");
});}$("#good-form").data("bootstrapValidator").destroy();$("#good-form").data("bootstrapValidator",null);F();}function a(ar,aq){var at=$(ar).val();if(at==="1"){$(ar).parent().parent().parent().find(".good_stock").show();
if(aq||aq==0){r.list[aq].is_stock=true;}}else{$(ar).parent().parent().parent().find(".good_stock").hide();if(aq||aq==0){r.list[aq].is_stock=false;}}$("#good-form").data("bootstrapValidator").destroy();
$("#good-form").data("bootstrapValidator",null);F();}function M(aq){var ar=$("#count-weight").find("option:selected").val();if(ar==="1"){$(".input-group-weight").each(function(){$(this).html("元/kg");
});}else{if(ar==="2"){$(".input-group-weight").each(function(){$(this).html("元/g");});}else{if(ar==="3"){$(".input-group-weight").each(function(){$(this).html("元/千克");
});}else{if(ar==="4"){$(".input-group-weight").each(function(){$(this).html("元/克");});}else{if(ar==="5"){$(".input-group-weight").each(function(){$(this).html("元/斤");
});}else{$(".input-group-weight").each(function(){$(this).html("元/两");});}}}}}}function Y(){$("#cate-form").bootstrapValidator({fields:{cate_name:{validators:{notEmpty:{message:"分类名称不能为空"},stringLength:{max:30,message:"分类名称不得超过30个字符"}}},cate_sort:{validators:{notEmpty:{message:"分类排序不能为空"}}}}}).on("success.form.bv",function(au){au.preventDefault();
var ar=U.val(),at=s.val(),aw=af.data("id"),aq,av;av={shop_id:i,cate_name:ar,sort:at};if(!aw){aq=__BASEURL__+"mshop/items_api/cate_add";}else{av.id=aw;aq=__BASEURL__+"mshop/items_api/cate_edit";
}af.prop("disabled",true);$.post(aq,autoCsrf(av),function(ax){if(ax.success){new Msg({type:"success",msg:ax.msg});m(i);}else{new Msg({type:"danger",msg:ax.msg});
}af.prop("disabled",false);J.modal("hide");});});}Y();function D(){J.modal("show");$("#cate-form").data("bootstrapValidator").destroy();$("#cate-form").data("bootstrapValidator",null);
Y();}function ai(){D();J.find(".modal-title").text("添加分类");U.val("");s.val("");af.data("id","");}window.addCate=ai;window.addMany=T;window.addManyItem=d;
window.delManyItem=b;window.addProp=X;window.addPropItem=t;window.addPropValue=n;window.delPropValue=c;window.delPropItem=k;window.changeSku=aj;window.changeSkuCode=ab;
window.changeProp=E;window.changeCate=P;window.changePropValue=j;window.changeMetering=ap;window.changeMember=x;window.changeWeightType=M;window.changeStockType=a;
window.changePrice=I;window.changeMemberPrice=q;window.changeBox=z;window.changeStock=aa;window.delLogo=v;});