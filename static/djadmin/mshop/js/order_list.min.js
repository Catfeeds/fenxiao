$(function(){function e(){G=GetQueryString("status")||"",v.val(G)}function s(){var e=GetQueryString("create_time");e&&(J=e,I=J.split(" - ")[0],P=J.split(" - ")[1])}function t(){function e(e,s){J=e.format("YYYY-MM-DD")+" - "+s.format("YYYY-MM-DD"),b.val(J),n(1)}b.daterangepicker({startDate:I,endDate:P,maxDate:P,applyClass:"btn-primary",cancelClass:"btn-default",locale:{applyLabel:"确认",cancelLabel:"取消",fromLabel:"起始时间",toLabel:"结束时间",customRangeLabel:"自定义",daysOfWeek:["日","一","二","三","四","五","六"],monthNames:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],firstDay:1,format:"YYYY-MM-DD"},ranges:{"今日":[moment(),moment()],"昨日":[moment().subtract(1,"days"),moment().subtract(1,"days")],"最近7日":[moment().subtract(6,"days"),moment()],"最近30日":[moment().subtract(29,"days"),moment()]}},e)}function n(e){$.getJSON(__BASEURL__+"mshop/order_api",{current_page:e||1,page_size:x,shop_id:H,status:G,create_time:J,tradeno:V,name:z,phone:Q},function(s){if(s.success){var t=Math.ceil(+s.data.total/x);$("#orderTbody").html(template(C,s.data)),laypage({cont:"orderPage",pages:t,curr:e||1,skin:"#5aa2e7",first:1,last:t,skip:!0,prev:"&lt",next:"&gt",jump:function(e,s){s||(n(e.curr),N=e.curr)}})}})}function a(e){$("#refundCon").html('<div class="m-empty-box"><p>加载中...</p></div>'),$.getJSON(__BASEURL__+"mshop/afs_api/detail",{id:e},function(e){e.success?$("#refundCon").html(template(k,e.data)):new Msg({type:"danger",msg:e.msg})})}function o(){$("#refuse-form").bootstrapValidator({fields:{refuse_reason:{validators:{notEmpty:{message:"拒绝理由不能为空"},stringLength:{max:80,message:"拒绝理由不得超过80个字符"}}}}}).on("success.form.bv",function(e){e.preventDefault();var s=A.data("afsno"),t=$("#refuse_reason").val();A.prop("disabled",!0),$.post(__BASEURL__+"mshop/afs_api/refuse",autoCsrf({afsno:s,reason:t}),function(e){e.success?(new Msg({type:"success",msg:"拒绝成功"}),n(N)):new Msg({type:"danger",msg:e.msg}),A.prop("disabled",!1),O.modal("hide")})})}function r(){O.modal("show"),$("#refuse_reason").val(""),A.prop("disabled",!1),$("#refuse-form").data("bootstrapValidator").destroy(),$("#refuse-form").data("bootstrapValidator",null),o()}function i(e,s){"0"!=e&&("1"==s?$("#refund-footer").hide():$("#refund-footer").show(),T.data("afsno",e),A.data("afsno",e),a(e)),B.modal("show")}function d(e){$.post(__BASEURL__+"mshop/order_api/orderAgree",autoCsrf({tradeno:e}),function(e){e.success?(new Msg({type:"success",msg:"接单成功"}),n(N)):new Msg({type:"danger",msg:e.msg})})}function c(e){$.post(__BASEURL__+"mshop/order_api/orderRefuse",autoCsrf({tradeno:e}),function(e){e.success?(new Msg({type:"success",msg:"拒接成功"}),n(N)):new Msg({type:"danger",msg:e.msg})})}function m(e){$.post(__BASEURL__+"mshop/order_api/printOrder",autoCsrf({tradeno:e}),function(s){s.success?2==+s.data.print_type?u(e,+s.data.print_times):(new Msg({type:"success",msg:"打印成功"}),n(N)):new Msg({type:"danger",msg:s.msg})})}function u(e,s){s=s||1,$.getJSON(__BASEURL__+"mshop/order_api/detail",{tradeno:e},function(e){if(e.success){if(!e.data)return;w(e.data),h.SET_PRINT_COPIES(s),h.PRINT()}else console.log(e.msg)})}function p(e){$.get(__BASEURL__+"mshop/task/simTakingOrder",{tradeno:e},function(e){e.success?(new Msg({type:"success",msg:"接单成功"}),n(N)):new Msg({type:"danger",msg:e.msg})})}function f(e){$.get(__BASEURL__+"mshop/task/simDeliveredOrder",{tradeno:e},function(e){e.success?(new Msg({type:"success",msg:"送达成功"}),n(N)):new Msg({type:"danger",msg:e.msg})})}function g(e){$.post(__BASEURL__+"mshop/order_api/confirmDelivered",autoCsrf({tradeno:e}),function(e){e.success?(new Msg({type:"success",msg:"确认成功"}),n(N)):new Msg({type:"danger",msg:e.msg})})}function _(e){$.post(__BASEURL__+"mshop/order_api/rePushOrder",autoCsrf({tradeno:e}),function(e){e.success?(new Msg({type:"success",msg:"重新派单成功"}),n(N)):new Msg({type:"danger",msg:e.msg})})}function l(e){$.post(__BASEURL__+"mshop/order_api/turnSellerDelivery",autoCsrf({tradeno:e}),function(e){e.success?(new Msg({type:"success",msg:"成功转换为商家配送"}),n(N)):new Msg({type:"danger",msg:e.msg})})}function w(e){var s=template(U,e);h=getLodop(),h.PRINT_INIT("云店宝订单"),h.ADD_PRINT_HTM(0,0,"100%","100%",s),h.SET_PRINT_PAGESIZE(3,570,5,"CreateCustomPage")}function y(){var e=__BASEURL__+"mshop/order_api/export_wm?shop_id="+H+"&current_page=1&page_size=9999&status="+G+"&create_time="+J+"&tradeno="+V+"&name="+z+"&phone="+Q;window.open(e)}var h,M=$("#shop"),v=$("#status"),b=$("#create_time"),S=$("#tradeno"),L=$("#name"),D=$("#phone"),E=$("#btn-search"),R=$("#btn-refresh"),Y=$("#btn-refuse"),T=$("#confirm-refund"),A=$("#confirm-refuse"),B=$("#refundModal"),O=$("#refuseModal"),C=document.getElementById("orderTpl").innerHTML,U=document.getElementById("orderPrintTpl").innerHTML,k=document.getElementById("refundTpl").innerHTML,I=moment().subtract(29,"days"),P=moment(),N=1,x=10,H=M.val(),G=v.val(),J=I.format("YYYY-MM-DD")+" - "+P.format("YYYY-MM-DD"),V=S.val(),z=L.val(),Q=D.val();e(),s(),t(),n(),o(),M.on("change",function(){H=$(this).val(),n(1)}),v.on("change",function(){G=$(this).val(),n(1)}),E.on("click",function(){V=S.val(),z=L.val(),Q=D.val(),n(1)}),R.on("click",function(){window.location.reload()}),T.on("click",function(){var e=$(this),s=e.data("afsno");e.prop("disabled",!0),$.post(__BASEURL__+"mshop/afs_api/agree",autoCsrf({afsno:s}),function(s){s.success?(new Msg({type:"success",msg:"退款成功"}),n(N)):new Msg({type:"danger",msg:s.msg}),e.prop("disabled",!1),B.modal("hide")})}),Y.on("click",function(){B.modal("hide"),r()}),window.agreeOrder=d,window.refuseOrder=c,window.refundOrder=i,window.printOrder=m,window.simTakingOrder=p,window.simDeliveredOrder=f,window.confirmDelivered=g,window.rePushOrder=_,window.turnSellerDelivery=l,window.exportOrder=y});