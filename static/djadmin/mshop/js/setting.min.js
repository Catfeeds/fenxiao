$(function(){function a(){p.find(".upload-again").show(),m.find("fieldset").prop("disabled",!1),!g&&d.prop("disabled",!1),u.hide(),c.show()}function e(){p.find(".upload-again").hide(),m.find("fieldset").prop("disabled",!0),d.prop("disabled",!0),u.show(),c.hide()}function s(){m.data("bootstrapValidator").destroy(),m.data("bootstrapValidator",null),i()}function i(){m.bootstrapValidator({excluded:[":disabled"],fields:{share_img:{validators:{notEmpty:{message:"分享图片不能为空"}}},share_title:{validators:{notEmpty:{message:"分享标题不能为空"}}},share_desc:{validators:{notEmpty:{message:"分享描述不能为空"},stringLength:{max:60,message:"分享描述不能超过60个字符"}}},domain:{validators:{notEmpty:{message:"自定义域名不能为空"},regexp:{regexp:/^[a-zA-Z][a-zA-Z\d]{4,}$/,message:"自定义域名需以字母开头，可包含字母和数字，至少4个字符"}}}}}).on("success.form.bv",function(a){a.preventDefault();var i=n.val(),t=o.val(),r=l.val(),p=d.val(),m={share_img:i,share_title:t,share_desc:r};g||(m.domain=p),h.prop("disabled",!0).text("保存中..."),$.post(__BASEURL__+"mshop/setting_api/save_mall_setting",autoCsrf(m),function(a){a.success?(s(),e(),new Msg({type:"success",msg:"保存成功",delay:1})):new Msg({type:"danger",msg:a.msg}),h.prop("disabled",!1).text("保存")})})}function t(){$.get(__BASEURL__+"mshop/setting_api/get_mall_setting",function(s){if(s.success){var i=s.data;if(!i)return void a();i.share_title&&"null"!==i.share_title&&o.val(i.share_title),i.share_desc&&"null"!==i.share_desc&&l.val(i.share_desc),i.share_img&&"null"!==i.share_img&&(n.val(i.share_img),p.find(".upload-again").show(),p.find(".upload-plus").hide(),p.find(".upload-pic").attr("src",__UPLOADURL__+i.share_img)),g=i.domain,g&&"null"!==g?(d.val(g),r.val("https://"+g+".m.waimaishop.com")):(d.val(i.aid),r.val("https://"+i.aid+".m.waimaishop.com")),i.share_title&&"null"!==i.share_title&&i.share_desc&&"null"!==i.share_desc&&i.share_img&&"null"!==i.share_img&&i.domain&&"null"!==i.domain?e():a()}else a(),new Msg({type:"danger",msg:s.msg})})}var n=$("#share_img"),o=$("#share_title"),l=$("#share_desc"),d=$("#domain"),r=$("#full_domain"),p=$("#upload-share-container"),m=$("#setting-form"),h=$("#btn-save"),u=$("#btn-edit"),_=$("#btn-cancel"),c=$("#action-box"),g="";i(),t(),uploadFile("main_header",{browse_button:"upload-share",container:"upload-share-container",drop_element:"upload-share-container",max_file_size:"1mb",chunk_size:"1mb",init:{FileUploaded:function(a,e,s){var i=JSON.parse(s.response),t=i.key,o=a.getOption("domain")+t;n.val(t).blur(),p.find(".upload-again").show(),p.find(".upload-plus").hide(),p.find(".upload-pic").attr("src",o)}}}),u.on("click",function(){s(),a()}),_.on("click",function(){s(),e()}),d.on("input",function(){r.val("https://"+$(this).val()+".m.waimaishop.com")})});