$(function(){var w=document.getElementById("classTpl").innerHTML,A=document.getElementById("manyTpl").innerHTML;var e=$("#goods_id").val(),n=$("#good_title"),H=$("#good_code"),f=$("#good_logo"),o=$("#good_price"),N=$("#good_member"),T=$("#good_detail"),ab=$("#good_box"),V=$("#editImgModal"),Q=$("#count-weight"),W=$("#btn-confirm");
var G=document.getElementById("logoTpl").innerHTML,k=document.getElementById("propTpl").innerHTML;var M=0,U="",s="",L=[],h=[],Z=0,E=1,q={list:[]},P={list:[{pic:""}]},u={list:[]};
if(!e){C();D();l();}else{D();aa();}function D(){$("#logoTbody").html(template(G,P));d();if($("#good-form").data("bootstrapValidator")){$("#good-form").data("bootstrapValidator").destroy();
$("#good-form").data("bootstrapValidator",null);C();}}function l(ae){$.getJSON(__BASEURL__+"mshop/items_api/get_all_cate",{shop_id:"0"},function(ah){if(ah.success){var ag={rows:ah.data};
$("#classTbody").html(template(w,ag));if(ae){for(var af=0;af<ae.length;af++){$(".cate-label[data-value='"+ae[af]+"']").addClass("active");}}}});}function aa(){$.getJSON(__BASEURL__+"mshop/store_goods_api/goods_info",{goods_id:e},function(ag){if(ag.success){P.list=[];
if(ag.data.picarr){var ae=ag.data.picarr.split(",");ae.forEach(function(ah){if(ah){P.list.push({pic:ah});}});}else{P.list.push({pic:ag.data.pict_url});
}if(P.list.length!=5){P.list.push({pic:""});}D();if(ag.data.pro_attrs){u.list=ag.data.pro_attrs;}if(u.list.length>0){$(".prop-group").hide();$("#prop").show();
$("#propTbody").html(template(k,u));}n.val(ag.data.title);T.val(ag.data.description);H.val(ag.data.goods_sn);h=ag.data.cate_ids.split(",");l(h);if(ag.data.measure_type==1){E=1;
$('[name="goodMetering"][value="1"]').prop("checked",true);}else{E=2;$('[name="goodMetering"][value="2"]').prop("checked",true);Q.show();$("#count-weight option[value='"+ag.data.unit_type+"']").attr("selected",true);
I();}if(ag.data.tag==0){$('[name="goodLabel"][value="0"]').prop("checked",true);}else{if(ag.data.tag==1){$('[name="goodLabel"][value="1"]').prop("checked",true);
}else{$('[name="goodLabel"][value="2"]').prop("checked",true);}}if(ag.data.sku_type==0){M=0;o.val(ag.data.inner_price);N.val(ag.data.sku[0].member_price);
ab.val(ag.data.sku[0].box_fee);U=ag.data.sku[0].id;}else{M=1;L=[];$("#many").show();$("#only-type-box").hide();for(var af=0;af<ag.data.sku.length;af++){q.list.push({sku_name:ag.data.sku[af].attr_names,box:ag.data.sku[af].box_fee,sku_code:ag.data.sku[af].goods_sku_sn,member_price:ag.data.sku[af].member_price,price:ag.data.sku[af].sale_price,sku_id:ag.data.sku[af].id});
}$("#manyTbody").html(template(A,q));}X();C();}else{new Msg({type:"danger",msg:ag.msg});}});}function d(){$(".upload-input").each(function(ae,af){$(this).on("click",function(){$(this).val("");
});$(this).on("change",function(ai){var ah=/\.(jpg|png|JPG|PNG)$/;if(!ah.test(ai.target.value)){new Msg({type:"danger",msg:"请上传jpg、png格式图片"});return;}var ag=new FileReader();
ag.onload=function(aj){z.imgSrc=aj.target.result;V.modal("show");$("#upload-logo").val("");y.setValue(0);J=$(".imageBox").cropbox(z);};ag.readAsDataURL(this.files[0]);
s=ae;});});}function t(af,ae){if(P.list.length==5){if(P.list[4].pic!=""){P.list.splice(ae,1);P.list.push({pic:""});}else{P.list.splice(ae,1);}}else{P.list.splice(ae,1);
}D();}var z={thumbBox:".thumbBox",spinner:".spinner",imgSrc:""};var J=$(".imageBox").cropbox(z);var y=new Slider("#ex1",{formatter:function(af){var ae=af/20+1;
J.zoomChange(ae);return"Current value: "+af;}});$("#btnCrop").on("click",function(){var ae=J.getDataURL();var af=g(ae);if(af.size>1024*1024){new Msg({type:"danger",msg:"请上传小于1M的图片"});
return;}ac(af,s);});$("#btnZoomIn").on("click",function(){J.zoomIn();});$("#btnZoomOut").on("click",function(){J.zoomOut();});function ac(af,ae){$.getJSON(__BASEURL__+"qiniu_api/get_token",{type:"wsc_goods"},function(ai,ag){if(ai.success){upload_url=ai.data.upload_url;
up_token=ai.data.up_token;var aj=new FormData();var ah="wsc_goods/"+new Date().getTime()+"_"+Math.floor(1000+Math.random()*(9999-1000))+".png";aj.append("file",af);
aj.append("key",ah);aj.append("token",up_token);$.ajax({url:upload_url,type:"post",processData:false,contentType:false,data:aj,dataType:"json",success:function(al,ao,aq){var an=aq.responseJSON;
var ak=an.key;var ap=__UPLOADURL__+ak;P.list[ae].pic=ak;$("#good_logo0").val(ak).blur();var am=P.list.length;if(am<5){if(P.list[am-1].pic){P.list.push({pic:""});
}}D();V.modal("hide");},error:function(ak,am,al){}});}});}function g(af){var ae=window.atob(af.split(",")[1]);var ai=new ArrayBuffer(ae.length);var ag=new Uint8Array(ai);
for(var ah=0;ah<ae.length;ah++){ag[ah]=ae.charCodeAt(ah);}return new Blob([ai],{type:"image/png"});}function O(){q.list.push({sku_name:"",price:"",box:""});
$("#many").show();$("#only-type-box").hide();$("#good-form").data("bootstrapValidator").destroy();$("#good-form").data("bootstrapValidator",null);$("#manyTbody").html(template(A,q));
M=1;C();X();}function X(){if(Z){$(".good_member").each(function(){$(this).prop("disabled",false);});}else{$(".good_member").each(function(){$(this).prop("disabled",true);
});}}function c(){q.list.push({sku_name:"",price:"",box:""});$("#good-form").data("bootstrapValidator").destroy();$("#good-form").data("bootstrapValidator",null);
$("#manyTbody").html(template(A,q));C();X();}function a(ae){if(q.list.length==1){q.list.splice(ae,1);$("#many").hide();$("#only-type-box").show();M=0;$("#good-form").data("bootstrapValidator").destroy();
$("#good-form").data("bootstrapValidator",null);C();}else{q.list.splice(ae,1);$("#good-form").data("bootstrapValidator").destroy();$("#good-form").data("bootstrapValidator",null);
$("#manyTbody").html(template(A,q));C();X();}}function R(){u.list.push({name:"",value:["",""]});$("#prop").show();$(".prop-group").hide();$("#good-form").data("bootstrapValidator").destroy();
$("#good-form").data("bootstrapValidator",null);$("#propTbody").html(template(k,u));C();}function r(){u.list.push({name:"",value:["",""]});$("#good-form").data("bootstrapValidator").destroy();
$("#good-form").data("bootstrapValidator",null);$("#propTbody").html(template(k,u));C();}function m(ae){if(u.list[ae].value.length>4){new Msg({type:"danger",msg:"商品属性内容最多5条"});
return;}u.list[ae].value.push("");$("#good-form").data("bootstrapValidator").destroy();$("#good-form").data("bootstrapValidator",null);$("#propTbody").html(template(k,u));
C();}function b(ae){if(u.list[ae].value.length<3){new Msg({type:"danger",msg:"商品属性内容最少2条"});return;}u.list[ae].value.pop();$("#good-form").data("bootstrapValidator").destroy();
$("#good-form").data("bootstrapValidator",null);$("#propTbody").html(template(k,u));C();}function j(ae){if(u.list.length==1){u.list.splice(ae,1);$("#prop").hide();
$(".prop-group").show();}else{u.list.splice(ae,1);}$("#good-form").data("bootstrapValidator").destroy();$("#good-form").data("bootstrapValidator",null);
$("#propTbody").html(template(k,u));C();}function C(){$("#good-form").bootstrapValidator({fields:{good_title:{validators:{notEmpty:{message:"商品标题不能为空"},stringLength:{max:60,message:"商品标题不得超过60个字符"}}},good_logo0:{validators:{notEmpty:{message:"请上传商品logo"}}},good_price:{validators:{notEmpty:{message:"商品价格不能为空"},regexp:{regexp:/^[+]{0,1}(\d+)$|^[+]{0,1}(\d+\.\d+)$/,message:"请输入正数"}}},good_member:{validators:{notEmpty:{message:"商品价格不能为空"},regexp:{regexp:/^[+]{0,1}(\d+)$|^[+]{0,1}(\d+\.\d+)$/,message:"请输入正数"}}},sku_name:{validators:{notEmpty:{message:"规格名称不能为空"}}},good_box:{validators:{regexp:{regexp:/^[+]{0,1}(\d+)$|^[+]{0,1}(\d+\.\d+)$/,message:"请输入正数"}}},good_detail:{validators:{stringLength:{max:80,message:"商品标题不得超过80个字符"}}},prop_name:{validators:{notEmpty:{message:"属性名称不能为空"}}},prop_value:{validators:{notEmpty:{message:"属性内容不能为空"}}}}}).on("success.form.bv",function(an){an.preventDefault();
var al=n.val(),au=[],ak=[],av=$('[name="goodLabel"]:checked').val(),ar=0,ag=H.val(),af=o.val(),at=T.val(),ao=ab.val(),am;var aq=[{attr_name:"商品规格",value:[""]}];
var ap=[{attr_name:"商品规格",value:L}];if(ao==""){ao=0;}var aj=[{sku_attr:[{attr:"商品规格",value:""}],goods_sku_sn:"",box_fee:ao,sale_price:af,sku_id:U}];var ah=[];
for(var ai=0;ai<q.list.length;ai++){var ae=q.list[ai].sku_name;L.push(q.list[ai].sku_name);if(q.list[ai].box==""){q.list[ai].box=0;}ah.push({sku_attr:[{attr:"商品规格",value:ae}],goods_sku_sn:q.list[ai].sku_code,box_fee:q.list[ai].box,sale_price:q.list[ai].price,sku_id:q.list[ai].sku_id});
}h=[];$(".cate-label.active").each(function(){h.push($(this).attr("data-value"));ak.push($(this).html());});h=h.toString();ak=ak.toString();P.list.forEach(function(aw){if(aw.pic){au.push(aw.pic);
}});if(E==1){ar=0;}else{ar=$("#count-weight option:selected").val();}if(M==0){am={goods_id:e,title:al,picarr:au.join(","),sku_type:M,tag:av,description:at,attr:JSON.stringify(aq),sku:JSON.stringify(aj),cate_ids:h,cate_names:ak,goods_sn:ag,measure_type:E,unit_type:ar,pro_attrs:JSON.stringify(u.list)};
}else{am={goods_id:e,title:al,picarr:au.join(","),sku_type:M,tag:av,description:at,attr:JSON.stringify(ap),sku:JSON.stringify(ah),cate_ids:h,cate_names:ak,goods_sn:ag,measure_type:E,unit_type:ar,pro_attrs:JSON.stringify(u.list)};
}if(!e){post_url=__BASEURL__+"mshop/store_goods_api/goods_add";}else{post_url=__BASEURL__+"mshop/store_goods_api/goods_edit";}W.prop("disabled",true);$.post(post_url,autoCsrf(am),function(aw){if(aw.success){new Msg({type:"success",msg:aw.msg,delay:1,});
window.location.href=__BASEURL__+"mshop/store_goods";}else{new Msg({type:"danger",msg:aw.msg});W.prop("disabled",false);}});});}function Y(af,ae){var ag=$(af).val();
q.list[ae].sku_name=ag;}function S(af,ae){var ag=$(af).val();q.list[ae].sku_code=ag;}function F(af,ae){var ag=$(af).val();q.list[ae].price=ag;}function p(af,ae){var ag=$(af).val();
q.list[ae].member_price=ag;}function x(af,ae){var ag=$(af).val();q.list[ae].box=ag;}function B(af,ae){var ag=$(af).val();u.list[ae].name=ag;}function i(ag,af,ae){var ah=$(ag).val();
u.list[af].value[ae]=ah;}function K(ae){if($(ae).hasClass("active")){$(ae).removeClass("active");}else{$(ae).addClass("active");}}function v(ae){$("#good-form").data("bootstrapValidator").destroy();
$("#good-form").data("bootstrapValidator",null);C();if($(ae).is(":checked")){Z=1;$(".good_member").each(function(){$(this).prop("disabled",false);});}else{Z=0;
$(".good_member").each(function(){$(this).val("");$(this).prop("disabled",true);});}}function ad(ae){var af=$(ae).val();if(af==="2"){E=2;Q.show();$(".input-group-weight").each(function(){$(this).html("元/kg");
});}else{E=1;Q.hide();$(".input-group-weight").each(function(){$(this).html("元");});}$("#good-form").data("bootstrapValidator").destroy();$("#good-form").data("bootstrapValidator",null);
C();}function I(){var ae=$("#count-weight").find("option:selected").val();if(ae==="1"){$(".input-group-weight").each(function(){$(this).html("元/kg");});
}else{if(ae==="2"){$(".input-group-weight").each(function(){$(this).html("元/g");});}else{if(ae==="3"){$(".input-group-weight").each(function(){$(this).html("元/千克");
});}else{if(ae==="4"){$(".input-group-weight").each(function(){$(this).html("元/克");});}else{if(ae==="5"){$(".input-group-weight").each(function(){$(this).html("元/斤");
});}else{$(".input-group-weight").each(function(){$(this).html("元/两");});}}}}}}window.addMany=O;window.addManyItem=c;window.delManyItem=a;window.addProp=R;
window.addPropItem=r;window.addPropValue=m;window.delPropValue=b;window.delPropItem=j;window.changeSku=Y;window.changeSkuCode=S;window.changeProp=B;window.changeCate=K;
window.changePropValue=i;window.changeMetering=ad;window.changeMember=v;window.changeWeightType=I;window.changePrice=F;window.changeMemberPrice=p;window.changeBox=x;
window.delLogo=t;});