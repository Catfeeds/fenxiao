function getLoginData(){$.get(__BASEURL__+"mshop/Mq_api/login",function(e){if(e.success){var t=e.data.is_shop_user;loginData=e.data.out_data,t&&loginData&&createWebSocket(wsUrl,loginData)}else console.log(e.msg)})}function createWebSocket(e,t){try{ws=new WebSocket(e),initEventHandle(t)}catch(t){reconnect(e)}}function initEventHandle(t){ws.onopen=function(){console.log("Connected"),ws.send(t),heartSend.reset().start()},ws.onmessage=function(e){var t=JSON.parse(e.data);handleMsg(t)},ws.onclose=function(e){console.log("ERROR",e),reconnect(wsUrl)},ws.onerror=function(){console.log("ERROR",e),reconnect(wsUrl)}}function reconnect(e){lockReconnect||(lockReconnect=!0,setTimeout(function(){loginData&&createWebSocket(e,loginData),lockReconnect=!1},2e3))}function handleMsg(e){switch(e.type){case"order_notify":alertOrder();break;case"order_printer":2==+e.print_type&&printOrder(e.tid,+e.print_times);break;default:console.log("未知消息类型：",e.type)}}function alertOrder(){new Msg({type:"success",msg:"你有1条新的云店宝订单，请及时处理",url:__BASEURL__+"mshop/order"}),orderMusic.paused&&orderMusic.play()}function printOrder(e,t){t=t||1,$.getJSON(__BASEURL__+"mshop/order_api/detail",{tradeno:e},function(e){if(e.success){if(!e.data)return;CreatePrintWebPage(e.data),LODOP.SET_PRINT_COPIES(t),LODOP.PRINT()}else console.log(e.msg)})}function printPreview(e,t){t=t||1,$.getJSON(__BASEURL__+"mshop/order_api/detail",{tradeno:e},function(e){if(e.success){if(!e.data)return;CreatePrintWebPage(e.data),LODOP.SET_PRINT_COPIES(t),LODOP.PREVIEW()}else console.log(e.msg)})}function CreatePrintWebPage(e){var t=template(orderPrintTpl,e);LODOP=getLodop(),LODOP.PRINT_INIT("云店宝订单"),LODOP.ADD_PRINT_HTM(0,0,"100%","100%",t),LODOP.SET_PRINT_PAGESIZE(3,570,5,"CreateCustomPage")}$(function(){function e(){$.getJSON(__BASEURL__+"/erp_api/get_login_url",function(e){e.success?$(".nav-item-product>a").attr("href",e.data.url):new Msg({type:"danger",msg:e.msg})})}function t(){setTimeout(function(){a.is(":hidden")||a.hide()},1e3)}var n=$("body"),o=$("#main-frame"),a=$("#loading-box");e(),$(".J_NAVBAR_NAV_ITEM a").on("click",function(e){var r=$(this),i=r.data("type"),s=r.attr("href");return e.preventDefault(),!!s&&("qq"==i?(window.open(s),!1):($(".J_NAVBAR_NAV_ITEM").removeClass("active"),r.parent().addClass("active"),a.is(":hidden")&&a.stop().fadeIn(),t(),"index"==i?(n.addClass("has-aside"),$("#J_NAV_HOME").click()):n.removeClass("has-aside"),void o.attr("src",s)))}),$(".J_NAV_ITEM a").on("click",function(e){var n=$(this),r=n.attr("href");return e.preventDefault(),!!r&&($(".J_NAV_ITEM").removeClass("active"),n.parent().addClass("active"),a.is(":hidden")&&a.stop().fadeIn(),t(),void o.attr("src",r))}),$(".J_TOGGLE_SUBNAV").on("click",function(){var e=$(this);e.next().slideToggle(),e.parent().toggleClass("open")}),$("body").on("click","a.message-box",function(e){var n=$(this).attr("href");return e.preventDefault(),!!n&&(a.is(":hidden")&&a.stop().fadeIn(),t(),void o.attr("src",n))}),a.stop().fadeIn(),o.on("load",function(){a.hide()})});var ws,wsUrl=__WSURL__,lockReconnect=!1,loginData,orderMusic=document.getElementById("order-music"),orderPrintTpl=document.getElementById("orderPrintTpl").innerHTML,LODOP,heartSend={interval:1e4,intervalObj:null,reset:function(){return clearTimeout(this.intervalObj),this},start:function(){this.intervalObj=setInterval(function(){ws&&1===ws.readyState&&ws.send("peng")},this.interval)}};getLoginData();