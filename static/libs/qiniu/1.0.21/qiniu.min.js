(function(global){function createCookie(e,t,r){var n=new Date;n.setTime(n.getTime()+24*r*60*60*1e3);var o="; expires="+n.toGMTString();document.cookie=e+"="+t+o+"; path=/"}function readCookie(e){for(var t=e+"=",r=document.cookie.split(";"),n=0,o=r.length;n<o;n++){for(var i=r[n];" "===i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(t))return i.substring(t.length,i.length)}return null}function QiniuJsSDK(){function log(e,t){for(var r="[qiniu-js-sdk]["+e+"]",n=r,o=0;o<t.length;o++)n+="string"==typeof t[o]?" "+t[o]:" "+that.stringifyJSON(t[o]);that.detectIEVersion()?console.log(n):(t.unshift(r),console.log.apply(console,t)),document.getElementById("qiniu-js-sdk-log")&&(document.getElementById("qiniu-js-sdk-log").innerHTML+="<p>"+n+"</p>")}function makeLogFunc(e){var t=e.toLowerCase();logger[t]=function(){if(window.console&&window.console.log&&logger.level>=logger[e]){var r=Array.prototype.slice.call(arguments);log(t,r)}}}function StatisticsLogger(){function e(){for(var e=[],r=0;r<n.length;r++)n[r].status!==o.finished&&e.push(n[r]),n[r].status===o.waiting&&t(n[r]);n=e}function t(e){e.status=o.processing;var t=that.createAjax();t.open("POST",r,!0),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.setRequestHeader("Authorization","UpToken "+that.token),t.onreadystatechange=function(){4===t.readyState&&(200===t.status?(logger.debug("[STATISTICS] successfully report log to server"),e.status=o.finished):(logger.debug("[STATISTICS] report log to server failed"),e.status=o.waiting))},t.send(e.log)}var r="https://uplog.qbox.me/log/3",n=[],o={waiting:0,processing:1,finished:2};this.log=function(e,t,r,i,a,s,u,l,g,d){var p=Array.prototype.join.call(arguments,",");n.push({log:p,status:o.waiting}),logger.debug("[STATISTICS] send log to statistics server",p)},setInterval(e,1e3)}var that=this;this.detectIEVersion=function(){for(var e=4,t=document.createElement("div"),r=t.getElementsByTagName("i");t.innerHTML="<!--[if gt IE "+e+"]><i></i><![endif]-->",r[0];)e++;return e>4&&e};var logger={MUTE:0,FATA:1,ERROR:2,WARN:3,INFO:4,DEBUG:5,TRACE:6,level:0};for(var property in logger)logger.hasOwnProperty(property)&&"number"==typeof logger[property]&&!logger.hasOwnProperty(property.toLowerCase())&&makeLogFunc(property);var qiniuUploadUrl;qiniuUploadUrl="https:"===window.location.protocol?"https://up.qbox.me":"http://upload.qiniu.com";var qiniuUploadUrls=["http://upload.qiniu.com","http://up.qiniu.com"],qiniuUpHosts={http:["http://upload.qiniu.com","http://up.qiniu.com"],https:["https://up.qbox.me"]},changeUrlTimes=0,statisticsLogger=new StatisticsLogger,ExtraErrors={ZeroSizeFile:-6,InvalidToken:-5,InvalidArgument:-4,InvalidFile:-3,Cancelled:-2,NetworkError:-1,UnknownError:0,TimedOut:-1001,UnknownHost:-1003,CannotConnectToHost:-1004,NetworkConnectionLost:-1005};this.resetUploadUrl=function(){var e="https:"===window.location.protocol?qiniuUpHosts.https:qiniuUpHosts.http,t=changeUrlTimes%e.length;qiniuUploadUrl=e[t],changeUrlTimes++,logger.debug("resetUploadUrl: "+qiniuUploadUrl)},this.isImage=function(e){return e=e.split(/[?#]/)[0],/\.(png|jpg|jpeg|gif|bmp)$/i.test(e)},this.getFileExtension=function(e){var t,r=e.split(".");return t=1===r.length||""===r[0]&&2===r.length?"":r.pop().toLowerCase()},this.utf8_encode=function(e){if(null===e||"undefined"==typeof e)return"";var t,r,n=e+"",o="",i=0;t=r=0,i=n.length;for(var a=0;a<i;a++){var s=n.charCodeAt(a),u=null;if(s<128)r++;else if(s>127&&s<2048)u=String.fromCharCode(s>>6|192,63&s|128);else if(63488&s^!0)u=String.fromCharCode(s>>12|224,s>>6&63|128,63&s|128);else{if(64512&s^!0)throw new RangeError("Unmatched trail surrogate at "+a);var l=n.charCodeAt(++a);if(64512&l^!0)throw new RangeError("Unmatched lead surrogate at "+(a-1));s=((1023&s)<<10)+(1023&l)+65536,u=String.fromCharCode(s>>18|240,s>>12&63|128,s>>6&63|128,63&s|128)}null!==u&&(r>t&&(o+=n.slice(t,r)),o+=u,t=r=a+1)}return r>t&&(o+=n.slice(t,i)),o},this.base64_decode=function(e){var t,r,n,o,i,a,s,u,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",g=0,d=0,p="",c=[];if(!e)return e;e+="";do o=l.indexOf(e.charAt(g++)),i=l.indexOf(e.charAt(g++)),a=l.indexOf(e.charAt(g++)),s=l.indexOf(e.charAt(g++)),u=o<<18|i<<12|a<<6|s,t=u>>16&255,r=u>>8&255,n=255&u,64===a?c[d++]=String.fromCharCode(t):64===s?c[d++]=String.fromCharCode(t,r):c[d++]=String.fromCharCode(t,r,n);while(g<e.length);return p=c.join("")},this.base64_encode=function(e){var t,r,n,o,i,a,s,u,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",g=0,d=0,p="",c=[];if(!e)return e;e=this.utf8_encode(e+"");do t=e.charCodeAt(g++),r=e.charCodeAt(g++),n=e.charCodeAt(g++),u=t<<16|r<<8|n,o=u>>18&63,i=u>>12&63,a=u>>6&63,s=63&u,c[d++]=l.charAt(o)+l.charAt(i)+l.charAt(a)+l.charAt(s);while(g<e.length);switch(p=c.join(""),e.length%3){case 1:p=p.slice(0,-2)+"==";break;case 2:p=p.slice(0,-1)+"="}return p},this.URLSafeBase64Encode=function(e){return e=this.base64_encode(e),e.replace(/\//g,"_").replace(/\+/g,"-")},this.URLSafeBase64Decode=function(e){return e=e.replace(/_/g,"/").replace(/-/g,"+"),this.base64_decode(e)},this.createAjax=function(e){var t={};return t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP")},this.parseJSON=function(data){if(window.JSON&&window.JSON.parse)return window.JSON.parse(data);var rx_dangerous=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,text=String(data);return rx_dangerous.lastIndex=0,rx_dangerous.test(text)&&(text=text.replace(rx_dangerous,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),eval("("+text+")")},this.stringifyJSON=function(e){if(window.JSON&&window.JSON.stringify)return window.JSON.stringify(e);switch(typeof e){case"string":return'"'+e.replace(/(["\\])/g,"\\$1")+'"';case"array":return"["+e.map(that.stringifyJSON).join(",")+"]";case"object":if(e instanceof Array){for(var t=[],r=e.length,n=0;n<r;n++)t.push(that.stringifyJSON(e[n]));return"["+t.join(",")+"]"}if(null===e)return"null";var o=[];for(var i in e)e.hasOwnProperty(i)&&o.push(that.stringifyJSON(i)+":"+that.stringifyJSON(e[i]));return"{"+o.join(",")+"}";case"number":return e;case!1:return e;case"boolean":return e}},this.trim=function(e){return null===e?"":e.replace(/^\s+|\s+$/g,"")},this.uploader=function(e){var t=function(){var t,r,n,o=that.detectIEVersion(),i="Safari"===moxie.core.utils.Env.browser&&moxie.core.utils.Env.version<=5&&"Windows"===moxie.core.utils.Env.os&&"7"===moxie.core.utils.Env.osVersion||"Safari"===moxie.core.utils.Env.browser&&"iOS"===moxie.core.utils.Env.os&&"7"===moxie.core.utils.Env.osVersion;o&&o<9&&e.chunk_size&&e.runtimes.indexOf("flash")>=0?e.chunk_size=0:i?e.chunk_size=0:(t=20,r=4<<t,n=plupload.parseSize(e.chunk_size),n>r&&(e.chunk_size=r))},r=function(e){for(var t=[],r=-1,n=0;n<e.length;n++){var o=e[n];o.indexOf("upload")!==-1&&(r=n),0===o.indexOf("-H")?t.push(o.split(" ")[2]):t.push(o)}if(r!==-1){var i=t[r];t[r]=t[0],t[0]=i}return t},n=function(e){var t=e.split(":"),r=t[0],n=that.parseJSON(that.URLSafeBase64Decode(t[2]));return n.ak=r,n.scope.indexOf(":")>=0?(n.bucket=n.scope.split(":")[0],n.key=n.scope.split(":")[1]):n.bucket=n.scope,n},o=function(t){var o=n(t),i=window.location.protocol+"//uc.qbox.me/v1/query?ak="+o.ak+"&bucket="+o.bucket;logger.debug("putPolicy: ",o),logger.debug("get uphosts from: ",i);var a,s=that.detectIEVersion();s&&s<=9?(a=new moxie.xhr.XMLHttpRequest,moxie.core.utils.Env.swf_url=e.flash_swf_url):a=that.createAjax(),a.open("GET",i,!1);var u=function(){if(logger.debug("ajax.readyState: ",a.readyState),4===a.readyState)if(logger.debug("ajax.status: ",a.status),a.status<400){var e=that.parseJSON(a.responseText);qiniuUpHosts.http=r(e.http.up),qiniuUpHosts.https=r(e.https.up),logger.debug("get new uphosts: ",qiniuUpHosts),that.resetUploadUrl()}else logger.error("get uphosts error: ",a.responseText)};s&&s<=9?a.bind("readystatechange",u):a.onreadystatechange=u,a.send()},i=function(t){return!that.token||e.uptoken_url&&that.tokenInfo.isExpired()?a(t):that.token},a=function(t){if(e.uptoken)that.token=e.uptoken;else if(e.uptoken_url){logger.debug("get uptoken from: ",that.uptoken_url);var r=that.createAjax();if(r.open("GET",that.uptoken_url+"?"+ +new Date,!1),r.send(),200===r.status){var n=that.parseJSON(r.responseText);that.token=n.uptoken;var i=that.token.split(":"),a=that.parseJSON(that.URLSafeBase64Decode(i[2]));that.tokenMap||(that.tokenMap={});var s=function(e){return Math.ceil(e.getTime()/1e3)},u=s(new Date(r.getResponseHeader("date"))),l=s(new Date);that.tokenInfo={serverDelay:l-u,deadline:a.deadline,isExpired:function(){var e=this.deadline-s(new Date)+this.serverDelay;return e<600}},logger.debug("get new uptoken: ",that.token),logger.debug("get token info: ",that.tokenInfo)}else logger.error("get uptoken error: ",r.responseText)}else e.uptoken_func?(logger.debug("get uptoken from uptoken_func"),that.token=e.uptoken_func(t),logger.debug("get new uptoken: ",that.token)):logger.error("one of [uptoken, uptoken_url, uptoken_func] settings in options is required!");return that.token&&o(that.token),that.token},s=function(t,r,n){var o="",i=!1;if(!e.save_key)if(i=t.getOption&&t.getOption("unique_names"),i=i||t.settings&&t.settings.unique_names){var a=that.getFileExtension(r.name);o=a?r.id+"."+a:r.id}else o="function"==typeof n?n(t,r):r.name;return o},u=function(e){if(e&&e.match){var t=e.match(/^https?:\/\/([^:^\/]*)/);return t?t[1]:""}return""},l=function(e){if(e&&e.match){var t=e.match(/(^https?)/);if(!t)return"";var r=t[1];return t=e.match(/^https?:\/\/([^:^\/]*):(\d*)/),t?t[2]:"http"===r?"80":"443"}return""};if(e.log_level&&(logger.level=e.log_level),!e.domain)throw"domain setting in options is required!";if(!e.browse_button)throw"browse_button setting in options is required!";if(!e.uptoken&&!e.uptoken_url&&!e.uptoken_func)throw"one of [uptoken, uptoken_url, uptoken_func] settings in options is required!";logger.debug("init uploader start"),logger.debug("environment: ",moxie.core.utils.Env),logger.debug("userAgent: ",navigator.userAgent);var g={},d=e.init&&e.init.Error,p=e.init&&e.init.FileUploaded;e.init.Error=function(){},e.init.FileUploaded=function(){},that.uptoken_url=e.uptoken_url,that.token="",that.key_handler="function"==typeof e.init.Key?e.init.Key:"",this.domain=e.domain;var c="",f={isResumeUpload:!1,resumeFilesize:0,startTime:"",currentTime:""};t(),logger.debug("invoke reset_chunk_size()"),logger.debug("op.chunk_size: ",e.chunk_size);var h={url:qiniuUploadUrl,multipart_params:{token:""}},m=that.detectIEVersion();m&&m<=9&&(h.multipart_params.accept="text/plain; charset=utf-8",logger.debug("add accept text/plain in multipart params")),plupload.extend(g,e,h),logger.debug("option: ",g);var v=new plupload.Uploader(g);logger.debug("new plupload.Uploader(option)"),v.bind("Init",function(t,r){logger.debug("Init event activated"),e.get_new_uptoken||a(null)}),logger.debug("bind Init event"),v.bind("FilesAdded",function(e,t){logger.debug("FilesAdded event activated");var r=e.getOption&&e.getOption("auto_start");r=r||e.settings&&e.settings.auto_start,logger.debug("auto_start: ",r),logger.debug("files: ",t);var n=function(){return"ios"===moxie.core.utils.Env.OS.toLowerCase()};if(n())for(var o=0;o<t.length;o++){var i=t[o],a=that.getFileExtension(i.name);i.name=i.id+"."+a}r&&setTimeout(function(){e.start(),logger.debug("invoke up.start()")},0),e.refresh()}),logger.debug("bind FilesAdded event"),v.bind("BeforeUpload",function(t,r){logger.debug("BeforeUpload event activated"),r._start_at=new Date,r.speed=r.speed||0,c="",e.get_new_uptoken&&a(r);var n=function(t,r,n){f.startTime=(new Date).getTime();var i;i=e.save_key?{token:that.token}:{key:s(t,r,n),token:that.token};var a=that.detectIEVersion();a&&a<=9&&(i.accept="text/plain; charset=utf-8",logger.debug("add accept text/plain in multipart params")),logger.debug("directUpload multipart_params_obj: ",i);var u=e.x_vars;if(void 0!==u&&"object"==typeof u)for(var l in u)u.hasOwnProperty(l)&&("function"==typeof u[l]?i["x:"+l]=u[l](t,r):"object"!=typeof u[l]&&(i["x:"+l]=u[l]));t.setOption({url:qiniuUploadUrl,multipart:!0,chunk_size:o()?e.max_file_size:void 0,multipart_params:i})},o=function(){var e=navigator.userAgent.toLowerCase();return!(!e.match(/MicroMessenger/i)&&"QQBrowser"!==moxie.core.utils.Env.browser&&!e.match(/V1_AND_SQ/i)||"android"!==moxie.core.utils.Env.OS.toLowerCase())},u=t.getOption&&t.getOption("chunk_size");if(u=u||t.settings&&t.settings.chunk_size,logger.debug("uploader.runtime: ",v.runtime),logger.debug("chunk_size: ",u),"html5"!==v.runtime&&"flash"!==v.runtime||!u)logger.debug("directUpload because uploader.runtime !== 'html5' || uploader.runtime !== 'flash' || !chunk_size"),n(t,r,that.key_handler);else if(r.size<u||o())logger.debug("directUpload because file.size < chunk_size || is_android_weixin_or_qq()"),n(t,r,that.key_handler);else{var l=localStorage.getItem(r.name),g=u;if(l){l=that.parseJSON(l);var d=(new Date).getTime(),p=l.time||0,h=864e5;d-p<h&&100!==l.percent&&r.size===l.total?(r.percent=l.percent,r.loaded=l.offset,c=l.ctx,f.isResumeUpload=!0,f.resumeFilesize=l.offset,l.offset+g>r.size&&(g=r.size-l.offset)):localStorage.removeItem(r.name)}f.startTime=(new Date).getTime();var m={},k=that.detectIEVersion();k&&k<=9&&(m.accept="text/plain; charset=utf-8",logger.debug("add accept text/plain in multipart params")),t.setOption({url:qiniuUploadUrl+"/mkblk/"+g,multipart:!1,chunk_size:u,required_features:"chunks",headers:{Authorization:"UpToken "+i(r)},multipart_params:m})}}),logger.debug("bind BeforeUpload event"),v.bind("UploadProgress",function(e,t){logger.trace("UploadProgress event activated"),f.currentTime=(new Date).getTime();var r=f.currentTime-f.startTime,n=t.loaded||0;f.isResumeUpload&&(n=t.loaded-f.resumeFilesize),t.speed=(n/r*1e3).toFixed(0)||0}),logger.debug("bind UploadProgress event"),v.bind("ChunkUploaded",function(e,t,r){logger.debug("ChunkUploaded event activated"),logger.debug("ChunkUploaded file: ",t),logger.debug("ChunkUploaded info: ",r);var n=that.parseJSON(r.response);logger.debug("ChunkUploaded res: ",n),c=c?c+","+n.ctx:n.ctx;var o=r.total-r.offset,a=e.getOption&&e.getOption("chunk_size");a=a||e.settings&&e.settings.chunk_size,o<a&&(e.setOption({url:qiniuUploadUrl+"/mkblk/"+o}),logger.debug("up.setOption url: ",qiniuUploadUrl+"/mkblk/"+o)),e.setOption({headers:{Authorization:"UpToken "+i(t)}}),localStorage.setItem(t.name,that.stringifyJSON({ctx:c,percent:t.percent,total:r.total,offset:r.offset,time:(new Date).getTime()}))}),logger.debug("bind ChunkUploaded event");var k=qiniuUploadUrls.length,b=function(e){return k-- >0?(setTimeout(function(){that.resetUploadUrl(),e.status=plupload.QUEUED,v.stop(),v.start()},0),!0):(k=qiniuUploadUrls.length,!1)};return v.bind("Error",function(t){return function(r,n){logger.error("Error event activated"),logger.error("err: ",n);var o=new Date,i="",a=n.file;if(a){switch(n.code){case plupload.FAILED:i="上传失败。请稍后再试。";break;case plupload.FILE_SIZE_ERROR:var s=r.getOption&&r.getOption("max_file_size");s=s||r.settings&&r.settings.max_file_size,i="浏览器最大可上传"+s+"。更大文件请使用命令行工具。";break;case plupload.FILE_EXTENSION_ERROR:i="文件验证失败。请稍后重试。";break;case plupload.HTTP_ERROR:if(""===n.response){if(i=n.message||"未知网络错误。",!b(a))return;break}var g=that.parseJSON(n.response),d=g.error;switch(n.status){case 400:i="请求报文格式错误。";break;case 401:i="客户端认证授权失败。请重试或提交反馈。";break;case 405:i="客户端请求错误。请重试或提交反馈。";break;case 579:i="资源上传成功，但回调失败。";break;case 599:if(i="网络连接异常。请重试或提交反馈。",!b(a))return;break;case 614:i="文件已存在。";try{g=that.parseJSON(g.error),d=g.error||"file exists"}catch(e){d=g.error||"file exists"}break;case 631:i="指定空间不存在。";break;case 701:i="上传数据块校验出错。请重试或提交反馈。";break;default:if(i="未知错误。",!b(a))return}i=i+"("+n.status+"："+d+")";break;case plupload.SECURITY_ERROR:i="安全配置错误。请联系网站管理员。";break;case plupload.GENERIC_ERROR:i="上传失败。请稍后再试。";break;case plupload.IO_ERROR:i="上传失败。请稍后再试。";break;case plupload.INIT_ERROR:i="网站配置错误。请联系网站管理员。",v.destroy();break;default:if(i=n.message+n.details,!b(a))return}t&&t(r,n,i)}if(r.refresh(),!e.disable_statistics_report){var p=n&&n.responseHeaders&&n.responseHeaders.match?n.responseHeaders.match(/(X-Reqid\:\ )([\w\.\%-]*)/):[],c=p[2],f=plupload.HTTP_ERROR?n.status:n.code,h=a._start_at?a._start_at.getTime():o.getTime();statisticsLogger.log(0===f?ExtraErrors.NetworkError:f,c,u(r.settings.url),void 0,l(r.settings.url),o.getTime()-h,h,n.file.size*(n.file.percent/100),"jssdk-"+r.runtime,a.size)}}}(d)),logger.debug("bind Error event"),v.bind("FileUploaded",function(t){return function(r,n,o){logger.debug("FileUploaded event activated"),logger.debug("FileUploaded file: ",n),logger.debug("FileUploaded info: ",o);var i=(new Date,function(r,n,o){if(logger.debug("FileUploaded last step:",o),e.downtoken_url){var i=that.createAjax();i.open("POST",e.downtoken_url,!0),i.setRequestHeader("Content-type","application/x-www-form-urlencoded"),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status){var e;try{e=that.parseJSON(i.responseText)}catch(e){throw"invalid json format"}var a={};plupload.extend(a,that.parseJSON(o.response),e),o.response=that.stringifyJSON(a),t&&t(r,n,o)}else v.trigger("Error",{status:i.status,response:i.responseText,file:n,code:plupload.HTTP_ERROR})},i.send("key="+that.parseJSON(o.response).key+"&domain="+e.domain)}else t&&t(r,n,o)}),a=that.parseJSON(o.response);if(c=c?c:a.ctx,logger.debug("ctx: ",c),c){var u="";logger.debug("save_key: ",e.save_key),e.save_key||(u=s(r,n,that.key_handler),u=u?"/key/"+that.URLSafeBase64Encode(u):"");var l="/fname/"+that.URLSafeBase64Encode(n.name);logger.debug("op.x_vars: ",e.x_vars);var g=e.x_vars,d="",p="";if(void 0!==g&&"object"==typeof g)for(var f in g)g.hasOwnProperty(f)&&("function"==typeof g[f]?d=that.URLSafeBase64Encode(g[f](r,n)):"object"!=typeof g[f]&&(d=that.URLSafeBase64Encode(g[f])),p+="/x:"+f+"/"+d);var h,m=qiniuUploadUrl+"/mkfile/"+n.size+u+l+p,k=that.detectIEVersion();k&&k<=9?(h=new moxie.xhr.XMLHttpRequest,moxie.core.utils.Env.swf_url=e.flash_swf_url):h=that.createAjax(),h.open("POST",m,!0),h.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),h.setRequestHeader("Authorization","UpToken "+that.token);var b=function(){if(logger.debug("ajax.readyState: ",h.readyState),4===h.readyState){localStorage.removeItem(n.name);var e;200===h.status?(e={status:h.status,response:h.responseText,responseHeaders:h.getAllResponseHeaders()},logger.debug("mkfile is success: ",e),i(r,n,e)):(e={status:h.status,response:h.responseText,file:n,code:-200,responseHeaders:h.getAllResponseHeaders()},logger.debug("mkfile is error: ",e),v.trigger("Error",e))}};k&&k<=9?h.bind("readystatechange",b):h.onreadystatechange=b,h.send(c),logger.debug("mkfile: ",m)}else i(r,n,o)}}(p)),logger.debug("bind FileUploaded event"),v.bind("FilesRemoved",function(t,r){var n=new Date;if(!e.disable_statistics_report)for(var o=0;o<r.length;o++)statisticsLogger.log(ExtraErrors.Cancelled,void 0,u(t.settings.url),void 0,l(t.settings.url),n.getTime()-r[o]._start_at.getTime(),r[o]._start_at.getTime(),r[o].size*r[o].percent/100,"jssdk-"+t.runtime,r[o].size)}),logger.debug("bind FilesRemoved event"),v.init(),logger.debug("invoke uploader.init()"),logger.debug("init uploader end"),v},this.getUrl=function(e){if(!e)return!1;e=encodeURI(e);var t=this.domain;return"/"!==t.slice(t.length-1)&&(t+="/"),t+e},this.imageView2=function(e,t){if(!/^\d$/.test(e.mode))return!1;var r=e.mode,n=e.w||"",o=e.h||"",i=e.q||"",a=e.format||"";if(!n&&!o)return!1;var s="imageView2/"+r;return s+=n?"/w/"+n:"",s+=o?"/h/"+o:"",s+=i?"/q/"+i:"",s+=a?"/format/"+a:"",t&&(s=this.getUrl(t)+"?"+s),s},this.imageMogr2=function(e,t){var r=e["auto-orient"]||"",n=e.thumbnail||"",o=e.strip||"",i=e.gravity||"",a=e.crop||"",s=e.quality||"",u=e.rotate||"",l=e.format||"",g=e.blur||"",d="imageMogr2";return d+=r?"/auto-orient":"",d+=n?"/thumbnail/"+n:"",d+=o?"/strip":"",d+=i?"/gravity/"+i:"",d+=s?"/quality/"+s:"",d+=a?"/crop/"+a:"",d+=u?"/rotate/"+u:"",d+=l?"/format/"+l:"",d+=g?"/blur/"+g:"",t&&(d=this.getUrl(t)+"?"+d),d},this.watermark=function(e,t){var r=e.mode;if(!r)return!1;var n="watermark/"+r;if(1===r){var o=e.image||"";if(!o)return!1;n+=o?"/image/"+this.URLSafeBase64Encode(o):""}else{if(2!==r)return!1;var i=e.text?e.text:"",a=e.font?e.font:"",s=e.fontsize?e.fontsize:"",u=e.fill?e.fill:"";if(!i)return!1;n+=i?"/text/"+this.URLSafeBase64Encode(i):"",n+=a?"/font/"+this.URLSafeBase64Encode(a):"",n+=s?"/fontsize/"+s:"",n+=u?"/fill/"+this.URLSafeBase64Encode(u):""}var l=e.dissolve||"",g=e.gravity||"",d=e.dx||"",p=e.dy||"";return n+=l?"/dissolve/"+l:"",n+=g?"/gravity/"+g:"",n+=d?"/dx/"+d:"",n+=p?"/dy/"+p:"",t&&(n=this.getUrl(t)+"?"+n),n},this.imageInfo=function(e){if(!e)return!1;var t,r=this.getUrl(e)+"?imageInfo",n=this.createAjax(),o=this;return n.open("GET",r,!1),n.onreadystatechange=function(){4===n.readyState&&200===n.status&&(t=o.parseJSON(n.responseText))},n.send(),t},this.exif=function(e){if(!e)return!1;var t,r=this.getUrl(e)+"?exif",n=this.createAjax(),o=this;return n.open("GET",r,!1),n.onreadystatechange=function(){4===n.readyState&&200===n.status&&(t=o.parseJSON(n.responseText))},n.send(),t},this.get=function(e,t){return!(!t||!e)&&("exif"===e?this.exif(t):"imageInfo"===e&&this.imageInfo(t))},this.pipeline=function(e,t){var r,n,o="[object Array]"===Object.prototype.toString.call(e),i="";if(o){for(var a=0,s=e.length;a<s;a++){if(r=e[a],!r.fop)return!1;switch(r.fop){case"watermark":i+=this.watermark(r)+"|";break;case"imageView2":i+=this.imageView2(r)+"|";break;case"imageMogr2":i+=this.imageMogr2(r)+"|";break;default:n=!0}if(n)return!1}if(t){i=this.getUrl(t)+"?"+i;var u=i.length;"|"===i.slice(u-1)&&(i=i.slice(0,u-1))}return i}return!1}}window.localStorage||(window.localStorage={setItem:function(e,t){createCookie(e,t,30)},getItem:function(e){return readCookie(e)},removeItem:function(e){createCookie(e,"",-1)}});var Qiniu=new QiniuJsSDK;global.Qiniu=Qiniu,global.QiniuJsSDK=QiniuJsSDK})(window);